/* phaser-platformer-dsl v0.1.0 */
"use strict";var PhaserPlatformerDSL=(()=>{var qe=Object.defineProperty;var vr=Object.getOwnPropertyDescriptor;var Ir=Object.getOwnPropertyNames;var Sr=Object.prototype.hasOwnProperty;var ht=(t,e)=>{for(var r in e)qe(t,r,{get:e[r],enumerable:!0})},_r=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Ir(e))!Sr.call(t,i)&&i!==r&&qe(t,i,{get:()=>e[i],enumerable:!(n=vr(e,i))||n.enumerable});return t};var Nr=t=>_r(qe({},"__esModule",{value:!0}),t);var pn={};ht(pn,{compile:()=>yr,generate:()=>mt,parseToAST:()=>ut});var M={};ht(M,{StringBuffer:()=>H,abstract:()=>k,assert:()=>j,checkNotNull:()=>Ve,clone:()=>Ar,copyWithoutDuplicates:()=>He,defineLazyProperty:()=>Ae,getDuplicates:()=>be,isLexical:()=>Ke,isSyntactic:()=>V,padLeft:()=>ze,repeat:()=>oe,repeatFn:()=>dt,repeatStr:()=>ft,unescapeCodePoint:()=>We,unexpectedObjToString:()=>me});var W={};for(let t=0;t<128;t++)W[t]=String.fromCharCode(t);W[39]="\\'";W[34]='\\"';W[92]="\\\\";W[8]="\\b";W[12]="\\f";W[10]="\\n";W[13]="\\r";W[9]="\\t";W[11]="\\v";function k(t){let e=t||"";return function(){throw new Error("this method "+e+" is abstract! (it has no implementation in class "+this.constructor.name+")")}}function j(t,e){if(!t)throw new Error(e||"Assertion failed")}function Ae(t,e,r){let n;Object.defineProperty(t,e,{get(){return n||(n=r.call(this)),n}})}function Ar(t){return t&&Object.assign({},t)}function dt(t,e){let r=[];for(;e-- >0;)r.push(t());return r}function ft(t,e){return new Array(e+1).join(t)}function oe(t,e){return dt(()=>t,e)}function be(t){let e=[];for(let r=0;r<t.length;r++){let n=t[r];t.lastIndexOf(n)!==r&&e.indexOf(n)<0&&e.push(n)}return e}function He(t){let e=[];return t.forEach(r=>{e.indexOf(r)<0&&e.push(r)}),e}function V(t){let e=t[0];return e===e.toUpperCase()}function Ke(t){return!V(t)}function ze(t,e,r){let n=r||" ";return t.length<e?ft(n,e-t.length)+t:t}function H(){this.strings=[]}H.prototype.append=function(t){this.strings.push(t)};H.prototype.contents=function(){return this.strings.join("")};var Ue=t=>String.fromCodePoint(parseInt(t,16));function We(t){if(t.charAt(0)==="\\")switch(t.charAt(1)){case"b":return"\b";case"f":return"\f";case"n":return`
`;case"r":return"\r";case"t":return"	";case"v":return"\v";case"x":return Ue(t.slice(2,4));case"u":return t.charAt(2)==="{"?Ue(t.slice(3,-1)):Ue(t.slice(2,6));default:return t.charAt(1)}else return t}function me(t){if(t==null)return String(t);let e=Object.prototype.toString.call(t);try{let r;return t.constructor&&t.constructor.name?r=t.constructor.name:e.indexOf("[object ")===0?r=e.slice(8,-1):r=typeof t,r+": "+JSON.stringify(String(t))}catch{return e}}function Ve(t,e="unexpected null value"){if(t==null)throw new Error(e);return t}var gt=t=>new RegExp(String.raw`\p{${t}}`,"u"),we=Object.fromEntries(["Cc","Cf","Cn","Co","Cs","Ll","Lm","Lo","Lt","Lu","Mc","Me","Mn","Nd","Nl","No","Pc","Pd","Pe","Pf","Pi","Po","Ps","Sc","Sk","Sm","So","Zl","Zp","Zs"].map(t=>[t,gt(t)]));we.Ltmo=/\p{Lt}|\p{Lm}|\p{Lo}/u;var Xe=Object.fromEntries(["XID_Start","XID_Continue","White_Space"].map(t=>[t,gt(t)]));var h=class t{constructor(){if(this.constructor===t)throw new Error("PExpr cannot be instantiated -- it's abstract")}withSource(e){return e&&(this.source=e.trimmed()),this}},w=Object.create(h.prototype),b=Object.create(h.prototype),x=class extends h{constructor(e){super(),this.obj=e}},I=class extends h{constructor(e,r){super(),this.from=e,this.to=r,this.matchCodePoint=e.length>1||r.length>1}},_=class extends h{constructor(e){super(),this.index=e}},g=class extends h{constructor(e){super(),this.terms=e}},X=class extends g{constructor(e,r,n){let i=e.rules[r].body;super([n,i]),this.superGrammar=e,this.name=r,this.body=n}},J=class extends g{constructor(e,r,n,i){let s=e.rules[r].body;super([...n,s,...i]),this.superGrammar=e,this.ruleName=r,this.expansionPos=n.length}},y=class extends h{constructor(e){super(),this.factors=e}},L=class extends h{constructor(e){super(),this.expr=e}},G=class extends L{},K=class extends L{},D=class extends L{};G.prototype.operator="*";K.prototype.operator="+";D.prototype.operator="?";G.prototype.minNumMatches=0;K.prototype.minNumMatches=1;D.prototype.minNumMatches=0;G.prototype.maxNumMatches=Number.POSITIVE_INFINITY;K.prototype.maxNumMatches=Number.POSITIVE_INFINITY;D.prototype.maxNumMatches=1;var N=class extends h{constructor(e){super(),this.expr=e}},A=class extends h{constructor(e){super(),this.expr=e}},P=class extends h{constructor(e){super(),this.expr=e}},f=class extends h{constructor(e,r=[]){super(),this.ruleName=e,this.args=r}isSyntactic(){return V(this.ruleName)}toMemoKey(){return this._memoKey||Object.defineProperty(this,"_memoKey",{value:this.toString()}),this._memoKey}},S=class extends h{constructor(e){if(super(),this.categoryOrProp=e,e in we)this.pattern=we[e];else if(e in Xe)this.pattern=Xe[e];else throw new Error(`Invalid Unicode category or property name: ${JSON.stringify(e)}`)}};function O(t,e){let r;return e?(r=new Error(e.getLineAndColumnMessage()+t),r.shortMessage=t,r.interval=e):r=new Error(t),r}function Pe(){return O("Interval sources don't match")}function yt(t){let e=new Error;return Object.defineProperty(e,"message",{enumerable:!0,get(){return t.message}}),Object.defineProperty(e,"shortMessage",{enumerable:!0,get(){return"Expected "+t.getExpectedText()}}),e.interval=t.getInterval(),e}function xt(t,e,r){let n=e?`Grammar ${t} is not declared in namespace '${e}'`:"Undeclared grammar "+t;return O(n,r)}function vt(t,e){return O("Grammar "+t.name+" is already declared in this namespace")}function It(t){return O(`Grammar '${t.name}' does not support incremental parsing`)}function ke(t,e,r){return O("Rule "+t+" is not declared in grammar "+e,r)}function St(t,e,r){return O("Cannot override rule "+t+" because it is not declared in "+e,r)}function _t(t,e,r){return O("Cannot extend rule "+t+" because it is not declared in "+e,r)}function Je(t,e,r,n){let i="Duplicate declaration for rule '"+t+"' in grammar '"+e+"'";return e!==r&&(i+=" (originally declared in '"+r+"')"),O(i,n)}function Le(t,e,r,n){return O("Wrong number of parameters for rule "+t+" (expected "+e+", got "+r+")",n)}function Nt(t,e,r,n){return O("Wrong number of arguments for rule "+t+" (expected "+e+", got "+r+")",n)}function Ye(t,e,r){return O("Duplicate parameter names in rule "+t+": "+e.join(", "),r)}function At(t,e){return O("Invalid parameter to rule "+t+": "+e+" has arity "+e.getArity()+", but parameter expressions must have arity 1",e.source)}var br="NOTE: A _syntactic rule_ is a rule whose name begins with a capital letter. See https://ohmjs.org/d/svl for more details.";function bt(t,e){return O("Cannot apply syntactic rule "+t+" from here (inside a lexical context)",e.source)}function wt(t){let{ruleName:e}=t;return O(`applySyntactic is for syntactic rules, but '${e}' is a lexical rule. `+br,t.source)}function Pt(t){return O("applySyntactic is not required here (in a syntactic context)",t.source)}function Ze(t,e){return O("Incorrect argument type: expected "+t,e.source)}function kt(t){return O("'...' can appear at most once in a rule body",t.source)}function Lt(t){let e=t._node;j(e&&e.isNonterminal()&&e.ctorName==="escapeChar_unicodeCodePoint");let r=t.children.slice(1,-1).map(i=>i.source),n=r[0].coverageWith(...r.slice(1));return O(`U+${n.contents} is not a valid Unicode code point`,n)}function Ce(t,e){let r=e.length>0?e[e.length-1].args:[],i="Nullable expression "+t.expr.substituteParams(r)+" is not allowed inside '"+t.operator+"' (possible infinite loop)";if(e.length>0){let s=e.map(a=>new f(a.ruleName,a.args)).join(`
`);i+=`
Application stack (most recent application last):
`+s}return O(i,t.expr.source)}function Qe(t,e,r,n){return O("Rule "+t+" involves an alternation which has inconsistent arity (expected "+e+", got "+r+")",n.source)}function wr(t){let e=t.map(r=>r.message);return O(["Errors:"].concat(e).join(`
- `),t[0].interval)}function Ct(t,e,r,n){let i=n.slice(0,-1).map(l=>{let u="  "+l[0].name+" > "+l[1];return l.length===3?u+" for '"+l[2]+"'":u}).join(`
`);i+=`
  `+e+" > "+t;let s="";t==="_iter"&&(s=[`
NOTE: as of Ohm v16, there is no default action for iteration nodes \u2014 see `,"  https://ohmjs.org/d/dsa for details."].join(`
`));let a=[`Missing semantic action for '${t}' in ${r} '${e}'.${s}`,"Action stack (most recent call last):",i].join(`
`),o=O(a);return o.name="missingSemanticAction",o}function Tt(t){if(t.length===1)throw t[0];if(t.length>1)throw wr(t)}function Pr(t){let e=0;return t.map(n=>{let i=n.toString();return e=Math.max(e,i.length),i}).map(n=>ze(n,e))}function Ot(t,e,r){let n=t.length,i=t.slice(0,r),s=t.slice(r+e.length);return(i+e+s).substr(0,n)}function kr(...t){let e=this,{offset:r}=e,{repeatStr:n}=M,i=new H;i.append("Line "+e.lineNum+", col "+e.colNum+`:
`);let s=Pr([e.prevLine==null?0:e.lineNum-1,e.lineNum,e.nextLine==null?0:e.lineNum+1]),a=(c,p,m)=>{i.append(m+s[c]+" | "+p+`
`)};e.prevLine!=null&&a(0,e.prevLine,"  "),a(1,e.line,"> ");let o=e.line.length,l=n(" ",o+1);for(let c=0;c<t.length;++c){let p=t[c][0],m=t[c][1];j(p>=0&&p<=m,"range start must be >= 0 and <= end");let d=r-e.colNum+1;p=Math.max(0,p-d),m=Math.min(m-d,o),l=Ot(l,n("~",m-p),p)}let u=2+s[1].length+3;return i.append(n(" ",u)),l=Ot(l,"^",e.colNum-1),i.append(l.replace(/ +$/,"")+`
`),e.nextLine!=null&&a(2,e.nextLine,"  "),i.contents()}var et=[];function Te(t){et.push(t)}function Et(t){et.forEach(e=>{e(t)}),et=null}function he(t,e){let r=1,n=1,i=0,s=0,a=null,o=null,l=-1;for(;i<e;){let p=t.charAt(i++);p===`
`?(r++,n=1,l=s,s=i):p!=="\r"&&n++}let u=t.indexOf(`
`,s);if(u===-1)u=t.length;else{let p=t.indexOf(`
`,u+1);a=p===-1?t.slice(u):t.slice(u,p),a=a.replace(/^\r?\n/,"").replace(/\r$/,"")}l>=0&&(o=t.slice(l,s).replace(/\r?\n$/,""));let c=t.slice(s,u).replace(/\r$/,"");return{offset:e,lineNum:r,colNum:n,line:c,prevLine:o,nextLine:a,toString:kr}}function ae(t,e,...r){return he(t,e).toString(...r)}var tt=(()=>{let t=0;return e=>""+e+t++})();var Z=class t{constructor(e,r,n){Object.defineProperty(this,"_sourceString",{value:e,configurable:!1,enumerable:!1,writable:!1}),this.startIdx=r,this.endIdx=n}get sourceString(){return this._sourceString}get contents(){return this._contents===void 0&&(this._contents=this.sourceString.slice(this.startIdx,this.endIdx)),this._contents}get length(){return this.endIdx-this.startIdx}coverageWith(...e){return t.coverage(...e,this)}collapsedLeft(){return new t(this.sourceString,this.startIdx,this.startIdx)}collapsedRight(){return new t(this.sourceString,this.endIdx,this.endIdx)}getLineAndColumn(){return he(this.sourceString,this.startIdx)}getLineAndColumnMessage(){let e=[this.startIdx,this.endIdx];return ae(this.sourceString,this.startIdx,e)}minus(e){if(this.sourceString!==e.sourceString)throw Pe();return this.startIdx===e.startIdx&&this.endIdx===e.endIdx?[]:this.startIdx<e.startIdx&&e.endIdx<this.endIdx?[new t(this.sourceString,this.startIdx,e.startIdx),new t(this.sourceString,e.endIdx,this.endIdx)]:this.startIdx<e.endIdx&&e.endIdx<this.endIdx?[new t(this.sourceString,e.endIdx,this.endIdx)]:this.startIdx<e.startIdx&&e.startIdx<this.endIdx?[new t(this.sourceString,this.startIdx,e.startIdx)]:[this]}relativeTo(e){if(this.sourceString!==e.sourceString)throw Pe();return j(this.startIdx>=e.startIdx&&this.endIdx<=e.endIdx,"other interval does not cover this one"),new t(this.sourceString,this.startIdx-e.startIdx,this.endIdx-e.startIdx)}trimmed(){let{contents:e}=this,r=this.startIdx+e.match(/^\s*/)[0].length,n=this.endIdx-e.match(/\s*$/)[0].length;return new t(this.sourceString,r,n)}subInterval(e,r){let n=this.startIdx+e;return new t(this.sourceString,n,n+r)}};Z.coverage=function(t,...e){let{startIdx:r,endIdx:n}=t;for(let i of e){if(i.sourceString!==t.sourceString)throw Pe();r=Math.min(r,i.startIdx),n=Math.max(n,i.endIdx)}return new Z(t.sourceString,r,n)};var Lr=65535,Rt=1114111,Q=class{constructor(e){this.source=e,this.pos=0,this.examinedLength=0}atEnd(){let e=this.pos>=this.source.length;return this.examinedLength=Math.max(this.examinedLength,this.pos+1),e}next(){let e=this.source[this.pos++];return this.examinedLength=Math.max(this.examinedLength,this.pos),e}nextCharCode(){let e=this.next();return e&&e.charCodeAt(0)}nextCodePoint(){let e=this.source.slice(this.pos++).codePointAt(0);return e>Lr&&(this.pos+=1),this.examinedLength=Math.max(this.examinedLength,this.pos),e}matchString(e,r){let n;if(r){for(n=0;n<e.length;n++){let i=this.next(),s=e[n];if(i==null||i.toUpperCase()!==s.toUpperCase())return!1}return!0}for(n=0;n<e.length;n++)if(this.next()!==e[n])return!1;return!0}sourceSlice(e,r){return this.source.slice(e,r)}interval(e,r){return new Z(this.source,e,r||this.pos)}};var ce=class{constructor(e,r,n,i,s,a,o){this.matcher=e,this.input=r,this.startExpr=n,this._cst=i,this._cstOffset=s,this._rightmostFailurePosition=a,this._rightmostFailures=o,this.failed()&&(Ae(this,"message",function(){let l="Expected "+this.getExpectedText();return ae(this.input,this.getRightmostFailurePosition())+l}),Ae(this,"shortMessage",function(){let l="expected "+this.getExpectedText(),u=he(this.input,this.getRightmostFailurePosition());return"Line "+u.lineNum+", col "+u.colNum+": "+l}))}succeeded(){return!!this._cst}failed(){return!this.succeeded()}getRightmostFailurePosition(){return this._rightmostFailurePosition}getRightmostFailures(){if(!this._rightmostFailures){this.matcher.setInput(this.input);let e=this.matcher._match(this.startExpr,{tracing:!1,positionToRecordFailures:this.getRightmostFailurePosition()});this._rightmostFailures=e.getRightmostFailures()}return this._rightmostFailures}toString(){return this.succeeded()?"[match succeeded]":"[match failed at position "+this.getRightmostFailurePosition()+"]"}getExpectedText(){if(this.succeeded())throw new Error("cannot get expected text of a successful MatchResult");let e=new H,r=this.getRightmostFailures();r=r.filter(n=>!n.isFluffy());for(let n=0;n<r.length;n++)n>0&&(n===r.length-1?e.append(r.length>2?", or ":" or "):e.append(", ")),e.append(r[n].toString());return e.contents()}getInterval(){let e=this.getRightmostFailurePosition();return new Z(this.input,e,e)}};var Oe=class{constructor(){this.applicationMemoKeyStack=[],this.memo={},this.maxExaminedLength=0,this.maxRightmostFailureOffset=-1,this.currentLeftRecursion=void 0}isActive(e){return this.applicationMemoKeyStack.indexOf(e.toMemoKey())>=0}enter(e){this.applicationMemoKeyStack.push(e.toMemoKey())}exit(){this.applicationMemoKeyStack.pop()}startLeftRecursion(e,r){r.isLeftRecursion=!0,r.headApplication=e,r.nextLeftRecursion=this.currentLeftRecursion,this.currentLeftRecursion=r;let{applicationMemoKeyStack:n}=this,i=n.indexOf(e.toMemoKey())+1,s=n.slice(i);r.isInvolved=function(a){return s.indexOf(a)>=0},r.updateInvolvedApplicationMemoKeys=function(){for(let a=i;a<n.length;a++){let o=n[a];this.isInvolved(o)||s.push(o)}}}endLeftRecursion(){this.currentLeftRecursion=this.currentLeftRecursion.nextLeftRecursion}shouldUseMemoizedResult(e){if(!e.isLeftRecursion)return!0;let{applicationMemoKeyStack:r}=this;for(let n=0;n<r.length;n++){let i=r[n];if(e.isInvolved(i))return!1}return!0}memoize(e,r){return this.memo[e]=r,this.maxExaminedLength=Math.max(this.maxExaminedLength,r.examinedLength),this.maxRightmostFailureOffset=Math.max(this.maxRightmostFailureOffset,r.rightmostFailureOffset),r}clearObsoleteEntries(e,r){if(e+this.maxExaminedLength<=r)return;let{memo:n}=this;this.maxExaminedLength=0,this.maxRightmostFailureOffset=-1,Object.keys(n).forEach(i=>{let s=n[i];e+s.examinedLength>r?delete n[i]:(this.maxExaminedLength=Math.max(this.maxExaminedLength,s.examinedLength),this.maxRightmostFailureOffset=Math.max(this.maxRightmostFailureOffset,s.rightmostFailureOffset))})}};var Cr="\u2717",Tr="\u2713",Or="\u22C5",Er="\u21D2",Rr="\u2409",Dr="\u240A",Fr="\u240D",rt={succeeded:1,isRootNode:2,isImplicitSpaces:4,isMemoized:8,isHeadOfLeftRecursion:16,terminatesLR:32};function Br(t){return oe(" ",t).join("")}function $r(t,e,r){let n=Dt(t.slice(e,e+r));return n.length<r?n+oe(" ",r-n.length).join(""):n}function Dt(t){return typeof t=="string"?t.replace(/ /g,Or).replace(/\t/g,Rr).replace(/\n/g,Dr).replace(/\r/g,Fr):String(t)}var te=class t{constructor(e,r,n,i,s,a,o){this.input=e,this.pos=this.pos1=r,this.pos2=n,this.source=new Z(e,r,n),this.expr=i,this.bindings=a,this.children=o||[],this.terminatingLREntry=null,this._flags=s?rt.succeeded:0}get displayString(){return this.expr.toDisplayString()}clone(){return this.cloneWithExpr(this.expr)}cloneWithExpr(e){let r=new t(this.input,this.pos,this.pos2,e,this.succeeded,this.bindings,this.children);return r.isHeadOfLeftRecursion=this.isHeadOfLeftRecursion,r.isImplicitSpaces=this.isImplicitSpaces,r.isMemoized=this.isMemoized,r.isRootNode=this.isRootNode,r.terminatesLR=this.terminatesLR,r.terminatingLREntry=this.terminatingLREntry,r}recordLRTermination(e,r){this.terminatingLREntry=new t(this.input,this.pos,this.pos2,this.expr,!1,[r],[e]),this.terminatingLREntry.terminatesLR=!0}walk(e,r){let n=e;typeof n=="function"&&(n={enter:n});function i(s,a,o){let l=!0;n.enter&&n.enter.call(r,s,a,o)===t.prototype.SKIP&&(l=!1),l&&(s.children.forEach(u=>{i(u,s,o+1)}),n.exit&&n.exit.call(r,s,a,o))}this.isRootNode?this.children.forEach(s=>{i(s,null,0)}):i(this,null,0)}toString(){let e=new H;return this.walk((r,n,i)=>{if(!r)return this.SKIP;if(r.expr.constructor.name!=="Alt"){if(e.append($r(r.input,r.pos,10)+Br(i*2+1)),e.append((r.succeeded?Tr:Cr)+" "+r.displayString),r.isHeadOfLeftRecursion&&e.append(" (LR)"),r.succeeded){let a=Dt(r.source.contents);e.append(" "+Er+"  "),e.append(typeof a=="string"?'"'+a+'"':a)}e.append(`
`)}}),e.contents()}};te.prototype.SKIP={};Object.keys(rt).forEach(t=>{let e=rt[t];Object.defineProperty(te.prototype,t,{get(){return(this._flags&e)!==0},set(r){r?this._flags|=e:this._flags&=~e}})});h.prototype.allowsSkippingPrecedingSpace=k("allowsSkippingPrecedingSpace");w.allowsSkippingPrecedingSpace=b.allowsSkippingPrecedingSpace=f.prototype.allowsSkippingPrecedingSpace=x.prototype.allowsSkippingPrecedingSpace=I.prototype.allowsSkippingPrecedingSpace=S.prototype.allowsSkippingPrecedingSpace=function(){return!0};g.prototype.allowsSkippingPrecedingSpace=L.prototype.allowsSkippingPrecedingSpace=P.prototype.allowsSkippingPrecedingSpace=A.prototype.allowsSkippingPrecedingSpace=N.prototype.allowsSkippingPrecedingSpace=_.prototype.allowsSkippingPrecedingSpace=y.prototype.allowsSkippingPrecedingSpace=function(){return!1};var de;Te(t=>{de=t});var Ee;h.prototype.assertAllApplicationsAreValid=function(t,e){Ee=0,this._assertAllApplicationsAreValid(t,e)};h.prototype._assertAllApplicationsAreValid=k("_assertAllApplicationsAreValid");w._assertAllApplicationsAreValid=b._assertAllApplicationsAreValid=x.prototype._assertAllApplicationsAreValid=I.prototype._assertAllApplicationsAreValid=_.prototype._assertAllApplicationsAreValid=S.prototype._assertAllApplicationsAreValid=function(t,e){};P.prototype._assertAllApplicationsAreValid=function(t,e){Ee++,this.expr._assertAllApplicationsAreValid(t,e),Ee--};g.prototype._assertAllApplicationsAreValid=function(t,e){for(let r=0;r<this.terms.length;r++)this.terms[r]._assertAllApplicationsAreValid(t,e)};y.prototype._assertAllApplicationsAreValid=function(t,e){for(let r=0;r<this.factors.length;r++)this.factors[r]._assertAllApplicationsAreValid(t,e)};L.prototype._assertAllApplicationsAreValid=N.prototype._assertAllApplicationsAreValid=A.prototype._assertAllApplicationsAreValid=function(t,e){this.expr._assertAllApplicationsAreValid(t,e)};f.prototype._assertAllApplicationsAreValid=function(t,e,r=!1){let n=e.rules[this.ruleName],i=V(t)&&Ee===0;if(!n)throw ke(this.ruleName,e.name,this.source);if(!r&&V(this.ruleName)&&!i)throw bt(this.ruleName,this);let s=this.args.length,a=n.formals.length;if(s!==a)throw Nt(this.ruleName,a,s,this.source);let o=de&&n===de.rules.applySyntactic;if(de&&n===de.rules.caseInsensitive&&!(this.args[0]instanceof x))throw Ze('a Terminal (e.g. "abc")',this.args[0]);if(o){let u=this.args[0];if(!(u instanceof f))throw Ze("a syntactic rule application",u);if(!V(u.ruleName))throw wt(u);if(i)throw Pt(this)}this.args.forEach(u=>{if(u._assertAllApplicationsAreValid(t,e,o),u.getArity()!==1)throw At(this.ruleName,u)})};h.prototype.assertChoicesHaveUniformArity=k("assertChoicesHaveUniformArity");w.assertChoicesHaveUniformArity=b.assertChoicesHaveUniformArity=x.prototype.assertChoicesHaveUniformArity=I.prototype.assertChoicesHaveUniformArity=_.prototype.assertChoicesHaveUniformArity=P.prototype.assertChoicesHaveUniformArity=S.prototype.assertChoicesHaveUniformArity=function(t){};g.prototype.assertChoicesHaveUniformArity=function(t){if(this.terms.length===0)return;let e=this.terms[0].getArity();for(let r=0;r<this.terms.length;r++){let n=this.terms[r];n.assertChoicesHaveUniformArity();let i=n.getArity();if(e!==i)throw Qe(t,e,i,n)}};X.prototype.assertChoicesHaveUniformArity=function(t){let e=this.terms[0].getArity(),r=this.terms[1].getArity();if(e!==r)throw Qe(t,r,e,this.terms[0])};y.prototype.assertChoicesHaveUniformArity=function(t){for(let e=0;e<this.factors.length;e++)this.factors[e].assertChoicesHaveUniformArity(t)};L.prototype.assertChoicesHaveUniformArity=function(t){this.expr.assertChoicesHaveUniformArity(t)};N.prototype.assertChoicesHaveUniformArity=function(t){};A.prototype.assertChoicesHaveUniformArity=function(t){this.expr.assertChoicesHaveUniformArity(t)};f.prototype.assertChoicesHaveUniformArity=function(t){};h.prototype.assertIteratedExprsAreNotNullable=k("assertIteratedExprsAreNotNullable");w.assertIteratedExprsAreNotNullable=b.assertIteratedExprsAreNotNullable=x.prototype.assertIteratedExprsAreNotNullable=I.prototype.assertIteratedExprsAreNotNullable=_.prototype.assertIteratedExprsAreNotNullable=S.prototype.assertIteratedExprsAreNotNullable=function(t){};g.prototype.assertIteratedExprsAreNotNullable=function(t){for(let e=0;e<this.terms.length;e++)this.terms[e].assertIteratedExprsAreNotNullable(t)};y.prototype.assertIteratedExprsAreNotNullable=function(t){for(let e=0;e<this.factors.length;e++)this.factors[e].assertIteratedExprsAreNotNullable(t)};L.prototype.assertIteratedExprsAreNotNullable=function(t){if(this.expr.assertIteratedExprsAreNotNullable(t),this.expr.isNullable(t))throw Ce(this,[])};D.prototype.assertIteratedExprsAreNotNullable=N.prototype.assertIteratedExprsAreNotNullable=A.prototype.assertIteratedExprsAreNotNullable=P.prototype.assertIteratedExprsAreNotNullable=function(t){this.expr.assertIteratedExprsAreNotNullable(t)};f.prototype.assertIteratedExprsAreNotNullable=function(t){this.args.forEach(e=>{e.assertIteratedExprsAreNotNullable(t)})};var fe=class{constructor(e){this.matchLength=e}get ctorName(){throw new Error("subclass responsibility")}numChildren(){return this.children?this.children.length:0}childAt(e){if(this.children)return this.children[e]}indexOfChild(e){return this.children.indexOf(e)}hasChildren(){return this.numChildren()>0}hasNoChildren(){return!this.hasChildren()}onlyChild(){if(this.numChildren()!==1)throw new Error("cannot get only child of a node of type "+this.ctorName+" (it has "+this.numChildren()+" children)");return this.firstChild()}firstChild(){if(this.hasNoChildren())throw new Error("cannot get first child of a "+this.ctorName+" node, which has no children");return this.childAt(0)}lastChild(){if(this.hasNoChildren())throw new Error("cannot get last child of a "+this.ctorName+" node, which has no children");return this.childAt(this.numChildren()-1)}childBefore(e){let r=this.indexOfChild(e);if(r<0)throw new Error("Node.childBefore() called w/ an argument that is not a child");if(r===0)throw new Error("cannot get child before first child");return this.childAt(r-1)}childAfter(e){let r=this.indexOfChild(e);if(r<0)throw new Error("Node.childAfter() called w/ an argument that is not a child");if(r===this.numChildren()-1)throw new Error("cannot get child after last child");return this.childAt(r+1)}isTerminal(){return!1}isNonterminal(){return!1}isIteration(){return!1}isOptional(){return!1}},q=class extends fe{get ctorName(){return"_terminal"}isTerminal(){return!0}get primitiveValue(){throw new Error("The `primitiveValue` property was removed in Ohm v17.")}},Re=class extends fe{constructor(e,r,n,i){super(i),this.ruleName=e,this.children=r,this.childOffsets=n}get ctorName(){return this.ruleName}isNonterminal(){return!0}isLexical(){return Ke(this.ctorName)}isSyntactic(){return V(this.ctorName)}},pe=class extends fe{constructor(e,r,n,i){super(n),this.children=e,this.childOffsets=r,this.optional=i}get ctorName(){return"_iter"}isIteration(){return!0}isOptional(){return this.optional}};h.prototype.eval=k("eval");w.eval=function(t){let{inputStream:e}=t,r=e.pos,n=e.nextCodePoint();return n!==void 0?(t.pushBinding(new q(String.fromCodePoint(n).length),r),!0):(t.processFailure(r,this),!1)};b.eval=function(t){let{inputStream:e}=t,r=e.pos;return e.atEnd()?(t.pushBinding(new q(0),r),!0):(t.processFailure(r,this),!1)};x.prototype.eval=function(t){let{inputStream:e}=t,r=e.pos;return e.matchString(this.obj)?(t.pushBinding(new q(this.obj.length),r),!0):(t.processFailure(r,this),!1)};I.prototype.eval=function(t){let{inputStream:e}=t,r=e.pos,n=this.matchCodePoint?e.nextCodePoint():e.nextCharCode();return n!==void 0&&this.from.codePointAt(0)<=n&&n<=this.to.codePointAt(0)?(t.pushBinding(new q(String.fromCodePoint(n).length),r),!0):(t.processFailure(r,this),!1)};_.prototype.eval=function(t){return t.eval(t.currentApplication().args[this.index])};P.prototype.eval=function(t){t.enterLexifiedContext();let e=t.eval(this.expr);return t.exitLexifiedContext(),e};g.prototype.eval=function(t){for(let e=0;e<this.terms.length;e++)if(t.eval(this.terms[e]))return!0;return!1};y.prototype.eval=function(t){for(let e=0;e<this.factors.length;e++){let r=this.factors[e];if(!t.eval(r))return!1}return!0};L.prototype.eval=function(t){let{inputStream:e}=t,r=e.pos,n=this.getArity(),i=[],s=[];for(;i.length<n;)i.push([]),s.push([]);let a=0,o=r,l;for(;a<this.maxNumMatches&&t.eval(this.expr);){if(e.pos===o)throw Ce(this,t._applicationStack);o=e.pos,a++;let m=t._bindings.splice(t._bindings.length-n,n),d=t._bindingOffsets.splice(t._bindingOffsets.length-n,n);for(l=0;l<m.length;l++)i[l].push(m[l]),s[l].push(d[l])}if(a<this.minNumMatches)return!1;let u=t.posToOffset(r),c=0;if(a>0){let m=i[n-1],d=s[n-1],v=d[d.length-1]+m[m.length-1].matchLength;u=s[0][0],c=v-u}let p=this instanceof D;for(l=0;l<i.length;l++)t._bindings.push(new pe(i[l],s[l],c,p)),t._bindingOffsets.push(u);return!0};N.prototype.eval=function(t){let{inputStream:e}=t,r=e.pos;t.pushFailuresInfo();let n=t.eval(this.expr);return t.popFailuresInfo(),n?(t.processFailure(r,this),!1):(e.pos=r,!0)};A.prototype.eval=function(t){let{inputStream:e}=t,r=e.pos;return t.eval(this.expr)?(e.pos=r,!0):!1};f.prototype.eval=function(t){let e=t.currentApplication(),r=e?e.args:[],n=this.substituteParams(r),i=t.getCurrentPosInfo();if(i.isActive(n))return n.handleCycle(t);let s=n.toMemoKey(),a=i.memo[s];if(a&&i.shouldUseMemoizedResult(a)){if(t.hasNecessaryInfo(a))return t.useMemoizedResult(t.inputStream.pos,a);delete i.memo[s]}return n.reallyEval(t)};f.prototype.handleCycle=function(t){let e=t.getCurrentPosInfo(),{currentLeftRecursion:r}=e,n=this.toMemoKey(),i=e.memo[n];return r&&r.headApplication.toMemoKey()===n?i.updateInvolvedApplicationMemoKeys():i||(i=e.memoize(n,{matchLength:0,examinedLength:0,value:!1,rightmostFailureOffset:-1}),e.startLeftRecursion(this,i)),t.useMemoizedResult(t.inputStream.pos,i)};f.prototype.reallyEval=function(t){let{inputStream:e}=t,r=e.pos,n=t.getCurrentPosInfo(),i=t.grammar.rules[this.ruleName],{body:s}=i,{description:a}=i;t.enterApplication(n,this),a&&t.pushFailuresInfo();let o=e.examinedLength;e.examinedLength=0;let l=this.evalOnce(s,t),u=n.currentLeftRecursion,c=this.toMemoKey(),p=u&&u.headApplication.toMemoKey()===c,m;t.doNotMemoize?t.doNotMemoize=!1:p?(l=this.growSeedResult(s,t,r,u,l),n.endLeftRecursion(),m=u,m.examinedLength=e.examinedLength-r,m.rightmostFailureOffset=t._getRightmostFailureOffset(),n.memoize(c,m)):(!u||!u.isInvolved(c))&&(m=n.memoize(c,{matchLength:e.pos-r,examinedLength:e.examinedLength-r,value:l,failuresAtRightmostPosition:t.cloneRecordedFailures(),rightmostFailureOffset:t._getRightmostFailureOffset()}));let d=!!l;if(a&&(t.popFailuresInfo(),d||t.processFailure(r,this),m&&(m.failuresAtRightmostPosition=t.cloneRecordedFailures())),t.isTracing()&&m){let v=t.getTraceEntry(r,this,d,d?[l]:[]);p&&(j(v.terminatingLREntry!=null||!d),v.isHeadOfLeftRecursion=!0),m.traceEntry=v}return e.examinedLength=Math.max(e.examinedLength,o),t.exitApplication(n,l),d};f.prototype.evalOnce=function(t,e){let{inputStream:r}=e,n=r.pos;if(e.eval(t)){let i=t.getArity(),s=e._bindings.splice(e._bindings.length-i,i),a=e._bindingOffsets.splice(e._bindingOffsets.length-i,i),o=r.pos-n;return new Re(this.ruleName,s,a,o)}else return!1};f.prototype.growSeedResult=function(t,e,r,n,i){if(!i)return!1;let{inputStream:s}=e;for(;;){if(n.matchLength=s.pos-r,n.value=i,n.failuresAtRightmostPosition=e.cloneRecordedFailures(),e.isTracing()){let a=e.trace[e.trace.length-1];n.traceEntry=new te(e.input,r,s.pos,this,!0,[i],[a.clone()])}if(s.pos=r,i=this.evalOnce(t,e),s.pos-r<=n.matchLength)break;e.isTracing()&&e.trace.splice(-2,1)}return e.isTracing()&&n.traceEntry.recordLRTermination(e.trace.pop(),i),s.pos=r+n.matchLength,n.value};S.prototype.eval=function(t){let{inputStream:e}=t,r=e.pos,n=e.nextCodePoint();if(n!==void 0&&n<=Rt){let i=String.fromCodePoint(n);if(this.pattern.test(i))return t.pushBinding(new q(i.length),r),!0}return t.processFailure(r,this),!1};h.prototype.getArity=k("getArity");w.getArity=b.getArity=x.prototype.getArity=I.prototype.getArity=_.prototype.getArity=f.prototype.getArity=S.prototype.getArity=function(){return 1};g.prototype.getArity=function(){return this.terms.length===0?0:this.terms[0].getArity()};y.prototype.getArity=function(){let t=0;for(let e=0;e<this.factors.length;e++)t+=this.factors[e].getArity();return t};L.prototype.getArity=function(){return this.expr.getArity()};N.prototype.getArity=function(){return 0};A.prototype.getArity=P.prototype.getArity=function(){return this.expr.getArity()};function z(t,e){let r={};if(t.source&&e){let n=t.source.relativeTo(e);r.sourceInterval=[n.startIdx,n.endIdx]}return r}h.prototype.outputRecipe=k("outputRecipe");w.outputRecipe=function(t,e){return["any",z(this,e)]};b.outputRecipe=function(t,e){return["end",z(this,e)]};x.prototype.outputRecipe=function(t,e){return["terminal",z(this,e),this.obj]};I.prototype.outputRecipe=function(t,e){return["range",z(this,e),this.from,this.to]};_.prototype.outputRecipe=function(t,e){return["param",z(this,e),this.index]};g.prototype.outputRecipe=function(t,e){return["alt",z(this,e)].concat(this.terms.map(r=>r.outputRecipe(t,e)))};X.prototype.outputRecipe=function(t,e){return this.terms[0].outputRecipe(t,e)};J.prototype.outputRecipe=function(t,e){let r=this.terms.slice(0,this.expansionPos),n=this.terms.slice(this.expansionPos+1);return["splice",z(this,e),r.map(i=>i.outputRecipe(t,e)),n.map(i=>i.outputRecipe(t,e))]};y.prototype.outputRecipe=function(t,e){return["seq",z(this,e)].concat(this.factors.map(r=>r.outputRecipe(t,e)))};G.prototype.outputRecipe=K.prototype.outputRecipe=D.prototype.outputRecipe=N.prototype.outputRecipe=A.prototype.outputRecipe=P.prototype.outputRecipe=function(t,e){return[this.constructor.name.toLowerCase(),z(this,e),this.expr.outputRecipe(t,e)]};f.prototype.outputRecipe=function(t,e){return["app",z(this,e),this.ruleName,this.args.map(r=>r.outputRecipe(t,e))]};S.prototype.outputRecipe=function(t,e){return["unicodeChar",z(this,e),this.categoryOrProp]};h.prototype.introduceParams=k("introduceParams");w.introduceParams=b.introduceParams=x.prototype.introduceParams=I.prototype.introduceParams=_.prototype.introduceParams=S.prototype.introduceParams=function(t){return this};g.prototype.introduceParams=function(t){return this.terms.forEach((e,r,n)=>{n[r]=e.introduceParams(t)}),this};y.prototype.introduceParams=function(t){return this.factors.forEach((e,r,n)=>{n[r]=e.introduceParams(t)}),this};L.prototype.introduceParams=N.prototype.introduceParams=A.prototype.introduceParams=P.prototype.introduceParams=function(t){return this.expr=this.expr.introduceParams(t),this};f.prototype.introduceParams=function(t){let e=t.indexOf(this.ruleName);if(e>=0){if(this.args.length>0)throw new Error("Parameterized rules cannot be passed as arguments to another rule.");return new _(e).withSource(this.source)}else return this.args.forEach((r,n,i)=>{i[n]=r.introduceParams(t)}),this};h.prototype.isNullable=function(t){return this._isNullable(t,Object.create(null))};h.prototype._isNullable=k("_isNullable");w._isNullable=I.prototype._isNullable=_.prototype._isNullable=K.prototype._isNullable=S.prototype._isNullable=function(t,e){return!1};b._isNullable=function(t,e){return!0};x.prototype._isNullable=function(t,e){return typeof this.obj=="string"?this.obj==="":!1};g.prototype._isNullable=function(t,e){return this.terms.length===0||this.terms.some(r=>r._isNullable(t,e))};y.prototype._isNullable=function(t,e){return this.factors.every(r=>r._isNullable(t,e))};G.prototype._isNullable=D.prototype._isNullable=N.prototype._isNullable=A.prototype._isNullable=function(t,e){return!0};P.prototype._isNullable=function(t,e){return this.expr._isNullable(t,e)};f.prototype._isNullable=function(t,e){let r=this.toMemoKey();if(!Object.prototype.hasOwnProperty.call(e,r)){let{body:n}=t.rules[this.ruleName],i=n.substituteParams(this.args);e[r]=!1,e[r]=i._isNullable(t,e)}return e[r]};h.prototype.substituteParams=k("substituteParams");w.substituteParams=b.substituteParams=x.prototype.substituteParams=I.prototype.substituteParams=S.prototype.substituteParams=function(t){return this};_.prototype.substituteParams=function(t){return Ve(t[this.index])};g.prototype.substituteParams=function(t){return new g(this.terms.map(e=>e.substituteParams(t)))};y.prototype.substituteParams=function(t){return new y(this.factors.map(e=>e.substituteParams(t)))};L.prototype.substituteParams=N.prototype.substituteParams=A.prototype.substituteParams=P.prototype.substituteParams=function(t){return new this.constructor(this.expr.substituteParams(t))};f.prototype.substituteParams=function(t){if(this.args.length===0)return this;{let e=this.args.map(r=>r.substituteParams(t));return new f(this.ruleName,e)}};function Ft(t){return/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(t)}function nt(t){let e=Object.create(null);t.forEach(r=>{e[r]=(e[r]||0)+1}),Object.keys(e).forEach(r=>{if(e[r]<=1)return;let n=1;t.forEach((i,s)=>{i===r&&(t[s]=i+"_"+n++)})})}h.prototype.toArgumentNameList=k("toArgumentNameList");w.toArgumentNameList=function(t,e){return["any"]};b.toArgumentNameList=function(t,e){return["end"]};x.prototype.toArgumentNameList=function(t,e){return typeof this.obj=="string"&&/^[_a-zA-Z0-9]+$/.test(this.obj)?["_"+this.obj]:["$"+t]};I.prototype.toArgumentNameList=function(t,e){let r=this.from+"_to_"+this.to;return Ft(r)||(r="_"+r),Ft(r)||(r="$"+t),[r]};g.prototype.toArgumentNameList=function(t,e){let r=this.terms.map(s=>s.toArgumentNameList(t,!0)),n=[],i=r[0].length;for(let s=0;s<i;s++){let a=[];for(let l=0;l<this.terms.length;l++)a.push(r[l][s]);let o=He(a);n.push(o.join("_or_"))}return e||nt(n),n};y.prototype.toArgumentNameList=function(t,e){let r=[];return this.factors.forEach(n=>{let i=n.toArgumentNameList(t,!0);r=r.concat(i),t+=i.length}),e||nt(r),r};L.prototype.toArgumentNameList=function(t,e){let r=this.expr.toArgumentNameList(t,e).map(n=>n[n.length-1]==="s"?n+"es":n+"s");return e||nt(r),r};D.prototype.toArgumentNameList=function(t,e){return this.expr.toArgumentNameList(t,e).map(r=>"opt"+r[0].toUpperCase()+r.slice(1))};N.prototype.toArgumentNameList=function(t,e){return[]};A.prototype.toArgumentNameList=P.prototype.toArgumentNameList=function(t,e){return this.expr.toArgumentNameList(t,e)};f.prototype.toArgumentNameList=function(t,e){return[this.ruleName]};S.prototype.toArgumentNameList=function(t,e){return["$"+t]};_.prototype.toArgumentNameList=function(t,e){return["param"+this.index]};h.prototype.toDisplayString=k("toDisplayString");g.prototype.toDisplayString=y.prototype.toDisplayString=function(){return this.source?this.source.trimmed().contents:"["+this.constructor.name+"]"};w.toDisplayString=b.toDisplayString=L.prototype.toDisplayString=N.prototype.toDisplayString=A.prototype.toDisplayString=P.prototype.toDisplayString=x.prototype.toDisplayString=I.prototype.toDisplayString=_.prototype.toDisplayString=function(){return this.toString()};f.prototype.toDisplayString=function(){if(this.args.length>0){let t=this.args.map(e=>e.toDisplayString());return this.ruleName+"<"+t.join(",")+">"}else return this.ruleName};S.prototype.toDisplayString=function(){return"Unicode ["+this.categoryOrProp+"] character"};function jr(t){return t==="description"||t==="string"||t==="code"}var F=class t{constructor(e,r,n){if(!jr(n))throw new Error("invalid Failure type: "+n);this.pexpr=e,this.text=r,this.type=n,this.fluffy=!1}getPExpr(){return this.pexpr}getText(){return this.text}getType(){return this.type}isDescription(){return this.type==="description"}isStringTerminal(){return this.type==="string"}isCode(){return this.type==="code"}isFluffy(){return this.fluffy}makeFluffy(){this.fluffy=!0}clearFluffy(){this.fluffy=!1}subsumes(e){return this.getText()===e.getText()&&this.type===e.type&&(!this.isFluffy()||this.isFluffy()&&e.isFluffy())}toString(){return this.type==="string"?JSON.stringify(this.getText()):this.getText()}clone(){let e=new t(this.pexpr,this.text,this.type);return this.isFluffy()&&e.makeFluffy(),e}toKey(){return this.toString()+"#"+this.type}};h.prototype.toFailure=k("toFailure");w.toFailure=function(t){return new F(this,"any object","description")};b.toFailure=function(t){return new F(this,"end of input","description")};x.prototype.toFailure=function(t){return new F(this,this.obj,"string")};I.prototype.toFailure=function(t){return new F(this,JSON.stringify(this.from)+".."+JSON.stringify(this.to),"code")};N.prototype.toFailure=function(t){let e=this.expr===w?"nothing":"not "+this.expr.toFailure(t);return new F(this,e,"description")};A.prototype.toFailure=function(t){return this.expr.toFailure(t)};f.prototype.toFailure=function(t){let{description:e}=t.rules[this.ruleName];return e||(e=(/^[aeiouAEIOU]/.test(this.ruleName)?"an":"a")+" "+this.ruleName),new F(this,e,"description")};S.prototype.toFailure=function(t){return new F(this,"a Unicode ["+this.categoryOrProp+"] character","description")};g.prototype.toFailure=function(t){let r="("+this.terms.map(n=>n.toFailure(t)).join(" or ")+")";return new F(this,r,"description")};y.prototype.toFailure=function(t){let r="("+this.factors.map(n=>n.toFailure(t)).join(" ")+")";return new F(this,r,"description")};L.prototype.toFailure=function(t){let e="("+this.expr.toFailure(t)+this.operator+")";return new F(this,e,"description")};h.prototype.toString=k("toString");w.toString=function(){return"any"};b.toString=function(){return"end"};x.prototype.toString=function(){return JSON.stringify(this.obj)};I.prototype.toString=function(){return JSON.stringify(this.from)+".."+JSON.stringify(this.to)};_.prototype.toString=function(){return"$"+this.index};P.prototype.toString=function(){return"#("+this.expr.toString()+")"};g.prototype.toString=function(){return this.terms.length===1?this.terms[0].toString():"("+this.terms.map(t=>t.toString()).join(" | ")+")"};y.prototype.toString=function(){return this.factors.length===1?this.factors[0].toString():"("+this.factors.map(t=>t.toString()).join(" ")+")"};L.prototype.toString=function(){return this.expr+this.operator};N.prototype.toString=function(){return"~"+this.expr};A.prototype.toString=function(){return"&"+this.expr};f.prototype.toString=function(){if(this.args.length>0){let t=this.args.map(e=>e.toString());return this.ruleName+"<"+t.join(",")+">"}else return this.ruleName};S.prototype.toString=function(){return"\\p{"+this.categoryOrProp+"}"};var ge=class t extends h{constructor(e){super(),this.obj=e}_getString(e){let r=e.currentApplication().args[this.obj.index];return j(r instanceof x,"expected a Terminal expression"),r.obj}allowsSkippingPrecedingSpace(){return!0}eval(e){let{inputStream:r}=e,n=r.pos,i=this._getString(e);return r.matchString(i,!0)?(e.pushBinding(new q(i.length),n),!0):(e.processFailure(n,this),!1)}getArity(){return 1}substituteParams(e){return new t(this.obj.substituteParams(e))}toDisplayString(){return this.obj.toDisplayString()+" (case-insensitive)"}toFailure(e){return new F(this,this.obj.toFailure(e)+" (case-insensitive)","description")}_isNullable(e,r){return this.obj._isNullable(e,r)}};var Bt;Te(t=>{Bt=t.rules.applySyntactic.body});var it=new f("spaces"),De=class{constructor(e,r,n){this.matcher=e,this.startExpr=r,this.grammar=e.grammar,this.input=e.getInput(),this.inputStream=new Q(this.input),this.memoTable=e._memoTable,this.userData=void 0,this.doNotMemoize=!1,this._bindings=[],this._bindingOffsets=[],this._applicationStack=[],this._posStack=[0],this.inLexifiedContextStack=[!1],this.rightmostFailurePosition=-1,this._rightmostFailurePositionStack=[],this._recordedFailuresStack=[],n!==void 0&&(this.positionToRecordFailures=n,this.recordedFailures=Object.create(null))}posToOffset(e){return e-this._posStack[this._posStack.length-1]}enterApplication(e,r){this._posStack.push(this.inputStream.pos),this._applicationStack.push(r),this.inLexifiedContextStack.push(!1),e.enter(r),this._rightmostFailurePositionStack.push(this.rightmostFailurePosition),this.rightmostFailurePosition=-1}exitApplication(e,r){let n=this._posStack.pop();this._applicationStack.pop(),this.inLexifiedContextStack.pop(),e.exit(),this.rightmostFailurePosition=Math.max(this.rightmostFailurePosition,this._rightmostFailurePositionStack.pop()),r&&this.pushBinding(r,n)}enterLexifiedContext(){this.inLexifiedContextStack.push(!0)}exitLexifiedContext(){this.inLexifiedContextStack.pop()}currentApplication(){return this._applicationStack[this._applicationStack.length-1]}inSyntacticContext(){let e=this.currentApplication();return e?e.isSyntactic()&&!this.inLexifiedContext():this.startExpr.factors[0].isSyntactic()}inLexifiedContext(){return this.inLexifiedContextStack[this.inLexifiedContextStack.length-1]}skipSpaces(){return this.pushFailuresInfo(),this.eval(it),this.popBinding(),this.popFailuresInfo(),this.inputStream.pos}skipSpacesIfInSyntacticContext(){return this.inSyntacticContext()?this.skipSpaces():this.inputStream.pos}maybeSkipSpacesBefore(e){return e.allowsSkippingPrecedingSpace()&&e!==it?this.skipSpacesIfInSyntacticContext():this.inputStream.pos}pushBinding(e,r){this._bindings.push(e),this._bindingOffsets.push(this.posToOffset(r))}popBinding(){this._bindings.pop(),this._bindingOffsets.pop()}numBindings(){return this._bindings.length}truncateBindings(e){for(;this._bindings.length>e;)this.popBinding()}getCurrentPosInfo(){return this.getPosInfo(this.inputStream.pos)}getPosInfo(e){let r=this.memoTable[e];return r||(r=this.memoTable[e]=new Oe),r}processFailure(e,r){if(this.rightmostFailurePosition=Math.max(this.rightmostFailurePosition,e),this.recordedFailures&&e===this.positionToRecordFailures){let n=this.currentApplication();n&&(r=r.substituteParams(n.args)),this.recordFailure(r.toFailure(this.grammar),!1)}}recordFailure(e,r){let n=e.toKey();this.recordedFailures[n]?this.recordedFailures[n].isFluffy()&&!e.isFluffy()&&this.recordedFailures[n].clearFluffy():this.recordedFailures[n]=r?e.clone():e}recordFailures(e,r){Object.keys(e).forEach(n=>{this.recordFailure(e[n],r)})}cloneRecordedFailures(){if(!this.recordedFailures)return;let e=Object.create(null);return Object.keys(this.recordedFailures).forEach(r=>{e[r]=this.recordedFailures[r].clone()}),e}getRightmostFailurePosition(){return this.rightmostFailurePosition}_getRightmostFailureOffset(){return this.rightmostFailurePosition>=0?this.posToOffset(this.rightmostFailurePosition):-1}getMemoizedTraceEntry(e,r){let n=this.memoTable[e];if(n&&r instanceof f){let i=n.memo[r.toMemoKey()];if(i&&i.traceEntry){let s=i.traceEntry.cloneWithExpr(r);return s.isMemoized=!0,s}}return null}getTraceEntry(e,r,n,i){if(r instanceof f){let s=this.currentApplication(),a=s?s.args:[];r=r.substituteParams(a)}return this.getMemoizedTraceEntry(e,r)||new te(this.input,e,this.inputStream.pos,r,n,i,this.trace)}isTracing(){return!!this.trace}hasNecessaryInfo(e){return this.trace&&!e.traceEntry?!1:this.recordedFailures&&this.inputStream.pos+e.rightmostFailureOffset===this.positionToRecordFailures?!!e.failuresAtRightmostPosition:!0}useMemoizedResult(e,r){this.trace&&this.trace.push(r.traceEntry);let n=this.inputStream.pos+r.rightmostFailureOffset;return this.rightmostFailurePosition=Math.max(this.rightmostFailurePosition,n),this.recordedFailures&&this.positionToRecordFailures===n&&r.failuresAtRightmostPosition&&this.recordFailures(r.failuresAtRightmostPosition,!0),this.inputStream.examinedLength=Math.max(this.inputStream.examinedLength,r.examinedLength+e),r.value?(this.inputStream.pos+=r.matchLength,this.pushBinding(r.value,e),!0):!1}eval(e){let{inputStream:r}=this,n=this._bindings.length,i=this.userData,s;this.recordedFailures&&(s=this.recordedFailures,this.recordedFailures=Object.create(null));let a=r.pos,o=this.maybeSkipSpacesBefore(e),l;this.trace&&(l=this.trace,this.trace=[]);let u=e.eval(this);if(this.trace){let c=this._bindings.slice(n),p=this.getTraceEntry(o,e,u,c);p.isImplicitSpaces=e===it,p.isRootNode=e===this.startExpr,l.push(p),this.trace=l}return u?this.recordedFailures&&r.pos===this.positionToRecordFailures&&Object.keys(this.recordedFailures).forEach(c=>{this.recordedFailures[c].makeFluffy()}):(r.pos=a,this.truncateBindings(n),this.userData=i),this.recordedFailures&&this.recordFailures(s,!1),e===Bt&&this.skipSpaces(),u}getMatchResult(){this.grammar._setUpMatchState(this),this.eval(this.startExpr);let e;this.recordedFailures&&(e=Object.keys(this.recordedFailures).map(n=>this.recordedFailures[n]));let r=this._bindings[0];return r&&(r.grammar=this.grammar),new ce(this.matcher,this.input,this.startExpr,r,this._bindingOffsets[0],this.rightmostFailurePosition,e)}getTrace(){this.trace=[];let e=this.getMatchResult(),r=this.trace[this.trace.length-1];return r.result=e,r}pushFailuresInfo(){this._rightmostFailurePositionStack.push(this.rightmostFailurePosition),this._recordedFailuresStack.push(this.recordedFailures)}popFailuresInfo(){this.rightmostFailurePosition=this._rightmostFailurePositionStack.pop(),this.recordedFailures=this._recordedFailuresStack.pop()}};var Fe=class{constructor(e){this.grammar=e,this._memoTable=[],this._input="",this._isMemoTableStale=!1}_resetMemoTable(){this._memoTable=[],this._isMemoTableStale=!1}getInput(){return this._input}setInput(e){return this._input!==e&&this.replaceInputRange(0,this._input.length,e),this}replaceInputRange(e,r,n){let i=this._input,s=this._memoTable;if(e<0||e>i.length||r<0||r>i.length||e>r)throw new Error("Invalid indices: "+e+" and "+r);this._input=i.slice(0,e)+n+i.slice(r),this._input!==i&&s.length>0&&(this._isMemoTableStale=!0);let a=s.slice(r);s.length=e;for(let o=0;o<n.length;o++)s.push(void 0);for(let o of a)s.push(o);for(let o=0;o<e;o++){let l=s[o];l&&l.clearObsoleteEntries(o,e)}return this}match(e,r={incremental:!0}){return this._match(this._getStartExpr(e),{incremental:r.incremental,tracing:!1})}trace(e,r={incremental:!0}){return this._match(this._getStartExpr(e),{incremental:r.incremental,tracing:!0})}_match(e,r={}){let n={tracing:!1,incremental:!0,positionToRecordFailures:void 0,...r};if(!n.incremental)this._resetMemoTable();else if(this._isMemoTableStale&&!this.grammar.supportsIncrementalParsing)throw It(this.grammar);let i=new De(this,e,n.positionToRecordFailures);return n.tracing?i.getTrace():i.getMatchResult()}_getStartExpr(e){let r=e||this.grammar.defaultStartRule;if(!r)throw new Error("Missing start rule argument -- the grammar has no default start rule.");let n=this.grammar.parseApplication(r);return new y([n,b])}};var ye=[],st=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),Be=class{constructor(e,r,n){this._node=e,this.source=r,this._baseInterval=n,e.isNonterminal()&&j(r===n),this._childWrappers=[]}_forgetMemoizedResultFor(e){delete this._node[this._semantics.attributeKeys[e]],this.children.forEach(r=>{r._forgetMemoizedResultFor(e)})}child(e){if(!(0<=e&&e<this._node.numChildren()))return;let r=this._childWrappers[e];if(!r){let n=this._node.childAt(e),i=this._node.childOffsets[e],s=this._baseInterval.subInterval(i,n.matchLength),a=n.isNonterminal()?s:this._baseInterval;r=this._childWrappers[e]=this._semantics.wrap(n,s,a)}return r}_children(){for(let e=0;e<this._node.numChildren();e++)this.child(e);return this._childWrappers}isIteration(){return this._node.isIteration()}isTerminal(){return this._node.isTerminal()}isNonterminal(){return this._node.isNonterminal()}isSyntactic(){return this.isNonterminal()&&this._node.isSyntactic()}isLexical(){return this.isNonterminal()&&this._node.isLexical()}isOptional(){return this._node.isOptional()}iteration(e){let r=e||[],n=r.map(a=>a._node),i=new pe(n,[],-1,!1),s=this._semantics.wrap(i,null,null);return s._childWrappers=r,s}get children(){return this._children()}get ctorName(){return this._node.ctorName}get numChildren(){return this._node.numChildren()}get sourceString(){return this.source.contents}},B=class t{constructor(e,r){let n=this;if(this.grammar=e,this.checkedActionDicts=!1,this.Wrapper=class extends(r?r.Wrapper:Be){constructor(i,s,a){super(i,s,a),n.checkActionDictsIfHaventAlready(),this._semantics=n}toString(){return"[semantics wrapper for "+n.grammar.name+"]"}},this.super=r,r){if(!(e.equals(this.super.grammar)||e._inheritsFrom(this.super.grammar)))throw new Error("Cannot extend a semantics for grammar '"+this.super.grammar.name+"' for use with grammar '"+e.name+"' (not a sub-grammar)");this.operations=Object.create(this.super.operations),this.attributes=Object.create(this.super.attributes),this.attributeKeys=Object.create(null);for(let i in this.attributes)Object.defineProperty(this.attributeKeys,i,{value:tt(i)})}else this.operations=Object.create(null),this.attributes=Object.create(null),this.attributeKeys=Object.create(null)}toString(){return"[semantics for "+this.grammar.name+"]"}checkActionDictsIfHaventAlready(){this.checkedActionDicts||(this.checkActionDicts(),this.checkedActionDicts=!0)}checkActionDicts(){let e;for(e in this.operations)this.operations[e].checkActionDict(this.grammar);for(e in this.attributes)this.attributes[e].checkActionDict(this.grammar)}toRecipe(e){function r(i){return i.super!==t.BuiltInSemantics._getSemantics()}let n=`(function(g) {
`;if(r(this)){n+="  var semantics = "+this.super.toRecipe(!0)+"(g";let i=this.super.grammar,s=this.grammar;for(;s!==i;)n+=".superGrammar",s=s.superGrammar;n+=`);
`,n+="  return g.extendSemantics(semantics)"}else n+="  return g.createSemantics()";return["Operation","Attribute"].forEach(i=>{let s=this[i.toLowerCase()+"s"];Object.keys(s).forEach(a=>{let{actionDict:o,formals:l,builtInDefault:u}=s[a],c=a;l.length>0&&(c+="("+l.join(", ")+")");let p;r(this)&&this.super[i.toLowerCase()+"s"][a]?p="extend"+i:p="add"+i,n+=`
    .`+p+"("+JSON.stringify(c)+", {";let m=[];Object.keys(o).forEach(d=>{if(o[d]!==u){let v=o[d].toString().trim();v=v.replace(/^.*\(/,"function("),m.push(`
      `+JSON.stringify(d)+": "+v)}}),n+=m.join(",")+`
    })`})}),n+=`;
  })`,e||(n=`(function() {
  var grammar = this.fromRecipe(`+this.grammar.toRecipe()+`);
  var semantics = `+n+`(grammar);
  return semantics;
});
`),n}addOperationOrAttribute(e,r,n){let i=e+"s",s=$t(r,e),{name:a}=s,{formals:o}=s;this.assertNewName(a,e);let l=Gr(e,a,p),u={_default:l};Object.keys(n).forEach(m=>{u[m]=n[m]});let c=e==="operation"?new ie(a,o,u,l):new xe(a,u,l);c.checkActionDict(this.grammar),this[i][a]=c;function p(...m){let d=this._semantics[i][a];if(arguments.length!==d.formals.length)throw new Error("Invalid number of arguments passed to "+a+" "+e+" (expected "+d.formals.length+", got "+arguments.length+")");let v=Object.create(null);for(let[ne,ue]of Object.entries(m)){let xr=d.formals[ne];v[xr]=ue}let E=this.args;this.args=v;let C=d.execute(this._semantics,this);return this.args=E,C}e==="operation"?(this.Wrapper.prototype[a]=p,this.Wrapper.prototype[a].toString=function(){return"["+a+" operation]"}):(Object.defineProperty(this.Wrapper.prototype,a,{get:p,configurable:!0}),Object.defineProperty(this.attributeKeys,a,{value:tt(a)}))}extendOperationOrAttribute(e,r,n){let i=e+"s";if($t(r,"attribute"),!(this.super&&r in this.super[i]))throw new Error("Cannot extend "+e+" '"+r+"': did not inherit an "+e+" with that name");if(st(this[i],r))throw new Error("Cannot extend "+e+" '"+r+"' again");let s=this[i][r].formals,a=this[i][r].actionDict,o=Object.create(a);Object.keys(n).forEach(l=>{o[l]=n[l]}),this[i][r]=e==="operation"?new ie(r,s,o):new xe(r,o),this[i][r].checkActionDict(this.grammar)}assertNewName(e,r){if(st(Be.prototype,e))throw new Error("Cannot add "+r+" '"+e+"': that's a reserved name");if(e in this.operations)throw new Error("Cannot add "+r+" '"+e+"': an operation with that name already exists");if(e in this.attributes)throw new Error("Cannot add "+r+" '"+e+"': an attribute with that name already exists")}wrap(e,r,n){let i=n||r;return e instanceof this.Wrapper?e:new this.Wrapper(e,r,i)}};function $t(t,e){if(!B.prototypeGrammar)return j(t.indexOf("(")===-1),{name:t,formals:[]};let r=B.prototypeGrammar.match(t,e==="operation"?"OperationSignature":"AttributeSignature");if(r.failed())throw new Error(r.message);return B.prototypeGrammarSemantics(r).parse()}function Gr(t,e,r){return function(...n){let s=(this._semantics.operations[e]||this._semantics.attributes[e]).formals.map(a=>this.args[a]);if(!this.isIteration()&&n.length===1)return r.apply(n[0],s);throw Ct(this.ctorName,e,t,ye)}}B.createSemantics=function(t,e){let r=new B(t,e!==void 0?e:B.BuiltInSemantics._getSemantics()),n=function(s){if(!(s instanceof ce))throw new TypeError("Semantics expected a MatchResult, but got "+me(s));if(s.failed())throw new TypeError("cannot apply Semantics to "+s.toString());let a=s._cst;if(a.grammar!==t)throw new Error("Cannot use a MatchResult from grammar '"+a.grammar.name+"' with a semantics for '"+t.name+"'");let o=new Q(s.input);return r.wrap(a,o.interval(s._cstOffset,s.input.length))};return n.addOperation=function(i,s){return r.addOperationOrAttribute("operation",i,s),n},n.extendOperation=function(i,s){return r.extendOperationOrAttribute("operation",i,s),n},n.addAttribute=function(i,s){return r.addOperationOrAttribute("attribute",i,s),n},n.extendAttribute=function(i,s){return r.extendOperationOrAttribute("attribute",i,s),n},n._getActionDict=function(i){let s=r.operations[i]||r.attributes[i];if(!s)throw new Error('"'+i+'" is not a valid operation or attribute name in this semantics for "'+t.name+'"');return s.actionDict},n._remove=function(i){let s;return i in r.operations?(s=r.operations[i],delete r.operations[i]):i in r.attributes&&(s=r.attributes[i],delete r.attributes[i]),delete r.Wrapper.prototype[i],s},n.getOperationNames=function(){return Object.keys(r.operations)},n.getAttributeNames=function(){return Object.keys(r.attributes)},n.getGrammar=function(){return r.grammar},n.toRecipe=function(i){return r.toRecipe(i)},n.toString=r.toString.bind(r),n._getSemantics=function(){return r},n};var ie=class{constructor(e,r,n,i){this.name=e,this.formals=r,this.actionDict=n,this.builtInDefault=i}checkActionDict(e){e._checkTopDownActionDict(this.typeName,this.name,this.actionDict)}execute(e,r){try{let{ctorName:n}=r._node,i=this.actionDict[n];return i?(ye.push([this,n]),i.apply(r,r._children())):r.isNonterminal()&&(i=this.actionDict._nonterminal,i)?(ye.push([this,"_nonterminal",n]),i.apply(r,r._children())):(ye.push([this,"default action",n]),this.actionDict._default.apply(r,r._children()))}finally{ye.pop()}}};ie.prototype.typeName="operation";var xe=class extends ie{constructor(e,r,n){super(e,[],r,n)}execute(e,r){let n=r._node,i=e.attributeKeys[this.name];return st(n,i)||(n[i]=ie.prototype.execute.call(this,e,r)),n[i]}};xe.prototype.typeName="attribute";var jt=["_iter","_terminal","_nonterminal","_default"];function Gt(t){return Object.keys(t.rules).sort().map(e=>t.rules[e])}var Mr=t=>t.replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"),Mt,qt,R=class t{constructor(e,r,n,i){if(this.name=e,this.superGrammar=r,this.rules=n,i){if(!(i in n))throw new Error("Invalid start rule: '"+i+"' is not a rule in grammar '"+e+"'");this.defaultStartRule=i}this._matchStateInitializer=void 0,this.supportsIncrementalParsing=!0}matcher(){return new Fe(this)}isBuiltIn(){return this===t.ProtoBuiltInRules||this===t.BuiltInRules}equals(e){if(this===e)return!0;if(e==null||this.name!==e.name||this.defaultStartRule!==e.defaultStartRule||!(this.superGrammar===e.superGrammar||this.superGrammar.equals(e.superGrammar)))return!1;let r=Gt(this),n=Gt(e);return r.length===n.length&&r.every((i,s)=>i.description===n[s].description&&i.formals.join(",")===n[s].formals.join(",")&&i.body.toString()===n[s].body.toString())}match(e,r){let n=this.matcher();return n.replaceInputRange(0,0,e),n.match(r)}trace(e,r){let n=this.matcher();return n.replaceInputRange(0,0,e),n.trace(r)}createSemantics(){return B.createSemantics(this)}extendSemantics(e){return B.createSemantics(this,e._getSemantics())}_checkTopDownActionDict(e,r,n){let i=[];for(let s in n){let a=n[s];if(!jt.includes(s)&&!(s in this.rules)){i.push(`'${s}' is not a valid semantic action for '${this.name}'`);continue}if(typeof a!="function"){i.push(`'${s}' must be a function in an action dictionary for '${this.name}'`);continue}let l=a.length,u=this._topDownActionArity(s);if(l!==u){let c;s==="_iter"||s==="_nonterminal"?c=`it should use a rest parameter, e.g. \`${s}(...children) {}\`. NOTE: this is new in Ohm v16 \u2014 see https://ohmjs.org/d/ati for details.`:c=`expected ${u}, got ${l}`,i.push(`Semantic action '${s}' has the wrong arity: ${c}`)}}if(i.length>0){let s=i.map(o=>"- "+o),a=new Error([`Found errors in the action dictionary of the '${r}' ${e}:`,...s].join(`
`));throw a.problems=i,a}}_topDownActionArity(e){return jt.includes(e)?0:this.rules[e].body.getArity()}_inheritsFrom(e){let r=this.superGrammar;for(;r;){if(r.equals(e,!0))return!0;r=r.superGrammar}return!1}toRecipe(e=void 0){let r={};this.source&&(r.source=this.source.contents);let n=null;this.defaultStartRule&&(n=this.defaultStartRule);let i={};Object.keys(this.rules).forEach(o=>{let l=this.rules[o],{body:u}=l,c=!this.superGrammar||!this.superGrammar.rules[o],p;c?p="define":p=u instanceof X?"extend":"override";let m={};if(l.source&&this.source){let E=l.source.relativeTo(this.source);m.sourceInterval=[E.startIdx,E.endIdx]}let d=c?l.description:null,v=u.outputRecipe(l.formals,this.source);i[o]=[p,m,d,l.formals,v]});let s="null";e?s=e:this.superGrammar&&!this.superGrammar.isBuiltIn()&&(s=this.superGrammar.toRecipe());let a=[...["grammar",r,this.name].map(JSON.stringify),s,...[n,i].map(JSON.stringify)];return Mr(`[${a.join(",")}]`)}toOperationActionDictionaryTemplate(){return this._toOperationOrAttributeActionDictionaryTemplate()}toAttributeActionDictionaryTemplate(){return this._toOperationOrAttributeActionDictionaryTemplate()}_toOperationOrAttributeActionDictionaryTemplate(){let e=new H;e.append("{");let r=!0;for(let n in this.rules){let{body:i}=this.rules[n];r?r=!1:e.append(","),e.append(`
`),e.append("  "),this.addSemanticActionTemplate(n,i,e)}return e.append(`
}`),e.contents()}addSemanticActionTemplate(e,r,n){n.append(e),n.append(": function(");let i=this._topDownActionArity(e);n.append(oe("_",i).join(", ")),n.append(`) {
`),n.append("  }")}parseApplication(e){let r;if(e.indexOf("<")===-1)r=new f(e);else{let i=Mt.match(e,"Base_application");r=qt(i,{})}if(!(r.ruleName in this.rules))throw ke(r.ruleName,this.name);let{formals:n}=this.rules[r.ruleName];if(n.length!==r.args.length){let{source:i}=this.rules[r.ruleName];throw Le(r.ruleName,n.length,r.args.length,i)}return r}_setUpMatchState(e){this._matchStateInitializer&&this._matchStateInitializer(e)}};R.ProtoBuiltInRules=new R("ProtoBuiltInRules",void 0,{any:{body:w,formals:[],description:"any character",primitive:!0},end:{body:b,formals:[],description:"end of input",primitive:!0},caseInsensitive:{body:new ge(new _(0)),formals:["str"],primitive:!0},lower:{body:new S("Ll"),formals:[],description:"a lowercase letter",primitive:!0},upper:{body:new S("Lu"),formals:[],description:"an uppercase letter",primitive:!0},unicodeLtmo:{body:new S("Ltmo"),formals:[],description:"a Unicode character in Lt, Lm, or Lo",primitive:!0},spaces:{body:new G(new f("space")),formals:[]},space:{body:new I("\0"," "),formals:[],description:"a space"}});R.initApplicationParser=function(t,e){Mt=t,qt=e};var ve=class{constructor(e){this.name=e}sourceInterval(e,r){return this.source.subInterval(e,r-e)}ensureSuperGrammar(){return this.superGrammar||this.withSuperGrammar(this.name==="BuiltInRules"?R.ProtoBuiltInRules:R.BuiltInRules),this.superGrammar}ensureSuperGrammarRuleForOverriding(e,r){let n=this.ensureSuperGrammar().rules[e];if(!n)throw St(e,this.superGrammar.name,r);return n}installOverriddenOrExtendedRule(e,r,n,i){let s=be(r);if(s.length>0)throw Ye(e,s,i);let a=this.ensureSuperGrammar().rules[e],o=a.formals,l=o?o.length:0;if(r.length!==l)throw Le(e,l,r.length,i);return this.install(e,r,n,a.description,i)}install(e,r,n,i,s,a=!1){return this.rules[e]={body:n.introduceParams(r),formals:r,description:i,source:s,primitive:a},this}withSuperGrammar(e){if(this.superGrammar)throw new Error("the super grammar of a GrammarDecl cannot be set more than once");return this.superGrammar=e,this.rules=Object.create(e.rules),e.isBuiltIn()||(this.defaultStartRule=e.defaultStartRule),this}withDefaultStartRule(e){return this.defaultStartRule=e,this}withSource(e){return this.source=new Q(e).interval(0,e.length),this}build(){let e=new R(this.name,this.ensureSuperGrammar(),this.rules,this.defaultStartRule);e._matchStateInitializer=e.superGrammar._matchStateInitializer,e.supportsIncrementalParsing=e.superGrammar.supportsIncrementalParsing;let r=[],n=!1;return Object.keys(e.rules).forEach(i=>{let{body:s}=e.rules[i];try{s.assertChoicesHaveUniformArity(i)}catch(a){r.push(a)}try{s.assertAllApplicationsAreValid(i,e)}catch(a){r.push(a),n=!0}}),n||Object.keys(e.rules).forEach(i=>{let{body:s}=e.rules[i];try{s.assertIteratedExprsAreNotNullable(e,[])}catch(a){r.push(a)}}),r.length>0&&Tt(r),this.source&&(e.source=this.source),e}define(e,r,n,i,s,a){if(this.ensureSuperGrammar(),this.superGrammar.rules[e])throw Je(e,this.name,this.superGrammar.name,s);if(this.rules[e])throw Je(e,this.name,this.name,s);let o=be(r);if(o.length>0)throw Ye(e,o,s);return this.install(e,r,n,i,s,a)}override(e,r,n,i,s){return this.ensureSuperGrammarRuleForOverriding(e,s),this.installOverriddenOrExtendedRule(e,r,n,s),this}extend(e,r,n,i,s){if(!this.ensureSuperGrammar().rules[e])throw _t(e,this.superGrammar.name,s);let o=new X(this.superGrammar,e,n);return o.source=n.source,this.installOverriddenOrExtendedRule(e,r,o,s),this}};var ee=class{constructor(){this.currentDecl=null,this.currentRuleName=null}newGrammar(e){return new ve(e)}grammar(e,r,n,i,s){let a=new ve(r);return n&&a.withSuperGrammar(n instanceof R?n:this.fromRecipe(n)),i&&a.withDefaultStartRule(i),e&&e.source&&a.withSource(e.source),this.currentDecl=a,Object.keys(s).forEach(o=>{this.currentRuleName=o;let l=s[o],u=l[0],c=l[1],p=l[2],m=l[3],d=this.fromRecipe(l[4]),v;a.source&&c&&c.sourceInterval&&(v=a.source.subInterval(c.sourceInterval[0],c.sourceInterval[1]-c.sourceInterval[0])),a[u](o,m,d,p,v)}),this.currentRuleName=this.currentDecl=null,a.build()}terminal(e){return new x(e)}range(e,r){return new I(e,r)}param(e){return new _(e)}alt(...e){let r=[];for(let n of e)n instanceof h||(n=this.fromRecipe(n)),n instanceof g?r=r.concat(n.terms):r.push(n);return r.length===1?r[0]:new g(r)}seq(...e){let r=[];for(let n of e)n instanceof h||(n=this.fromRecipe(n)),n instanceof y?r=r.concat(n.factors):r.push(n);return r.length===1?r[0]:new y(r)}star(e){return e instanceof h||(e=this.fromRecipe(e)),new G(e)}plus(e){return e instanceof h||(e=this.fromRecipe(e)),new K(e)}opt(e){return e instanceof h||(e=this.fromRecipe(e)),new D(e)}not(e){return e instanceof h||(e=this.fromRecipe(e)),new N(e)}lookahead(e){return e instanceof h||(e=this.fromRecipe(e)),new A(e)}lex(e){return e instanceof h||(e=this.fromRecipe(e)),new P(e)}app(e,r){return r&&r.length>0&&(r=r.map(function(n){return n instanceof h?n:this.fromRecipe(n)},this)),new f(e,r)}splice(e,r){return new J(this.currentDecl.superGrammar,this.currentRuleName,e.map(n=>this.fromRecipe(n)),r.map(n=>this.fromRecipe(n)))}fromRecipe(e){let r=e[0]==="grammar"?e.slice(1):e.slice(2),n=this[e[0]](...r),i=e[1];return i&&i.sourceInterval&&this.currentDecl&&n.withSource(this.currentDecl.sourceInterval(...i.sourceInterval)),n}};function se(t){return typeof t=="function"?t.call(new ee):(typeof t=="string"&&(t=JSON.parse(t)),new ee().fromRecipe(t))}var Ie=se(["grammar",{source:`BuiltInRules {

  alnum  (an alpha-numeric character)
    = letter
    | digit

  letter  (a letter)
    = lower
    | upper
    | unicodeLtmo

  digit  (a digit)
    = "0".."9"

  hexDigit  (a hexadecimal digit)
    = digit
    | "a".."f"
    | "A".."F"

  ListOf<elem, sep>
    = NonemptyListOf<elem, sep>
    | EmptyListOf<elem, sep>

  NonemptyListOf<elem, sep>
    = elem (sep elem)*

  EmptyListOf<elem, sep>
    = /* nothing */

  listOf<elem, sep>
    = nonemptyListOf<elem, sep>
    | emptyListOf<elem, sep>

  nonemptyListOf<elem, sep>
    = elem (sep elem)*

  emptyListOf<elem, sep>
    = /* nothing */

  // Allows a syntactic rule application within a lexical context.
  applySyntactic<app> = app
}`},"BuiltInRules",null,null,{alnum:["define",{sourceInterval:[18,78]},"an alpha-numeric character",[],["alt",{sourceInterval:[60,78]},["app",{sourceInterval:[60,66]},"letter",[]],["app",{sourceInterval:[73,78]},"digit",[]]]],letter:["define",{sourceInterval:[82,142]},"a letter",[],["alt",{sourceInterval:[107,142]},["app",{sourceInterval:[107,112]},"lower",[]],["app",{sourceInterval:[119,124]},"upper",[]],["app",{sourceInterval:[131,142]},"unicodeLtmo",[]]]],digit:["define",{sourceInterval:[146,177]},"a digit",[],["range",{sourceInterval:[169,177]},"0","9"]],hexDigit:["define",{sourceInterval:[181,254]},"a hexadecimal digit",[],["alt",{sourceInterval:[219,254]},["app",{sourceInterval:[219,224]},"digit",[]],["range",{sourceInterval:[231,239]},"a","f"],["range",{sourceInterval:[246,254]},"A","F"]]],ListOf:["define",{sourceInterval:[258,336]},null,["elem","sep"],["alt",{sourceInterval:[282,336]},["app",{sourceInterval:[282,307]},"NonemptyListOf",[["param",{sourceInterval:[297,301]},0],["param",{sourceInterval:[303,306]},1]]],["app",{sourceInterval:[314,336]},"EmptyListOf",[["param",{sourceInterval:[326,330]},0],["param",{sourceInterval:[332,335]},1]]]]],NonemptyListOf:["define",{sourceInterval:[340,388]},null,["elem","sep"],["seq",{sourceInterval:[372,388]},["param",{sourceInterval:[372,376]},0],["star",{sourceInterval:[377,388]},["seq",{sourceInterval:[378,386]},["param",{sourceInterval:[378,381]},1],["param",{sourceInterval:[382,386]},0]]]]],EmptyListOf:["define",{sourceInterval:[392,434]},null,["elem","sep"],["seq",{sourceInterval:[438,438]}]],listOf:["define",{sourceInterval:[438,516]},null,["elem","sep"],["alt",{sourceInterval:[462,516]},["app",{sourceInterval:[462,487]},"nonemptyListOf",[["param",{sourceInterval:[477,481]},0],["param",{sourceInterval:[483,486]},1]]],["app",{sourceInterval:[494,516]},"emptyListOf",[["param",{sourceInterval:[506,510]},0],["param",{sourceInterval:[512,515]},1]]]]],nonemptyListOf:["define",{sourceInterval:[520,568]},null,["elem","sep"],["seq",{sourceInterval:[552,568]},["param",{sourceInterval:[552,556]},0],["star",{sourceInterval:[557,568]},["seq",{sourceInterval:[558,566]},["param",{sourceInterval:[558,561]},1],["param",{sourceInterval:[562,566]},0]]]]],emptyListOf:["define",{sourceInterval:[572,682]},null,["elem","sep"],["seq",{sourceInterval:[685,685]}]],applySyntactic:["define",{sourceInterval:[685,710]},null,["app"],["param",{sourceInterval:[707,710]},0]]}]);R.BuiltInRules=Ie;Et(R.BuiltInRules);var Se=se(["grammar",{source:`Ohm {

  Grammars
    = Grammar*

  Grammar
    = ident SuperGrammar? "{" Rule* "}"

  SuperGrammar
    = "<:" ident

  Rule
    = ident Formals? ruleDescr? "="  RuleBody  -- define
    | ident Formals?            ":=" OverrideRuleBody  -- override
    | ident Formals?            "+=" RuleBody  -- extend

  RuleBody
    = "|"? NonemptyListOf<TopLevelTerm, "|">

  TopLevelTerm
    = Seq caseName  -- inline
    | Seq

  OverrideRuleBody
    = "|"? NonemptyListOf<OverrideTopLevelTerm, "|">

  OverrideTopLevelTerm
    = "..."  -- superSplice
    | TopLevelTerm

  Formals
    = "<" ListOf<ident, ","> ">"

  Params
    = "<" ListOf<Seq, ","> ">"

  Alt
    = NonemptyListOf<Seq, "|">

  Seq
    = Iter*

  Iter
    = Pred "*"  -- star
    | Pred "+"  -- plus
    | Pred "?"  -- opt
    | Pred

  Pred
    = "~" Lex  -- not
    | "&" Lex  -- lookahead
    | Lex

  Lex
    = "#" Base  -- lex
    | Base

  Base
    = ident Params? ~(ruleDescr? "=" | ":=" | "+=")  -- application
    | oneCharTerminal ".." oneCharTerminal           -- range
    | terminal                                       -- terminal
    | "(" Alt ")"                                    -- paren

  ruleDescr  (a rule description)
    = "(" ruleDescrText ")"

  ruleDescrText
    = (~")" any)*

  caseName
    = "--" (~"\\n" space)* name (~"\\n" space)* ("\\n" | &"}")

  name  (a name)
    = nameFirst nameRest*

  nameFirst
    = "_"
    | letter

  nameRest
    = "_"
    | alnum

  ident  (an identifier)
    = name

  terminal
    = "\\"" terminalChar* "\\""

  oneCharTerminal
    = "\\"" terminalChar "\\""

  terminalChar
    = escapeChar
      | ~"\\\\" ~"\\"" ~"\\n" "\\u{0}".."\\u{10FFFF}"

  escapeChar  (an escape sequence)
    = "\\\\\\\\"                                     -- backslash
    | "\\\\\\""                                     -- doubleQuote
    | "\\\\\\'"                                     -- singleQuote
    | "\\\\b"                                      -- backspace
    | "\\\\n"                                      -- lineFeed
    | "\\\\r"                                      -- carriageReturn
    | "\\\\t"                                      -- tab
    | "\\\\u{" hexDigit hexDigit? hexDigit?
             hexDigit? hexDigit? hexDigit? "}"   -- unicodeCodePoint
    | "\\\\u" hexDigit hexDigit hexDigit hexDigit  -- unicodeEscape
    | "\\\\x" hexDigit hexDigit                    -- hexEscape

  space
   += comment

  comment
    = "//" (~"\\n" any)* &("\\n" | end)  -- singleLine
    | "/*" (~"*/" any)* "*/"  -- multiLine

  tokens = token*

  token = caseName | comment | ident | operator | punctuation | terminal | any

  operator = "<:" | "=" | ":=" | "+=" | "*" | "+" | "?" | "~" | "&"

  punctuation = "<" | ">" | "," | "--"
}`},"Ohm",null,"Grammars",{Grammars:["define",{sourceInterval:[9,32]},null,[],["star",{sourceInterval:[24,32]},["app",{sourceInterval:[24,31]},"Grammar",[]]]],Grammar:["define",{sourceInterval:[36,83]},null,[],["seq",{sourceInterval:[50,83]},["app",{sourceInterval:[50,55]},"ident",[]],["opt",{sourceInterval:[56,69]},["app",{sourceInterval:[56,68]},"SuperGrammar",[]]],["terminal",{sourceInterval:[70,73]},"{"],["star",{sourceInterval:[74,79]},["app",{sourceInterval:[74,78]},"Rule",[]]],["terminal",{sourceInterval:[80,83]},"}"]]],SuperGrammar:["define",{sourceInterval:[87,116]},null,[],["seq",{sourceInterval:[106,116]},["terminal",{sourceInterval:[106,110]},"<:"],["app",{sourceInterval:[111,116]},"ident",[]]]],Rule_define:["define",{sourceInterval:[131,181]},null,[],["seq",{sourceInterval:[131,170]},["app",{sourceInterval:[131,136]},"ident",[]],["opt",{sourceInterval:[137,145]},["app",{sourceInterval:[137,144]},"Formals",[]]],["opt",{sourceInterval:[146,156]},["app",{sourceInterval:[146,155]},"ruleDescr",[]]],["terminal",{sourceInterval:[157,160]},"="],["app",{sourceInterval:[162,170]},"RuleBody",[]]]],Rule_override:["define",{sourceInterval:[188,248]},null,[],["seq",{sourceInterval:[188,235]},["app",{sourceInterval:[188,193]},"ident",[]],["opt",{sourceInterval:[194,202]},["app",{sourceInterval:[194,201]},"Formals",[]]],["terminal",{sourceInterval:[214,218]},":="],["app",{sourceInterval:[219,235]},"OverrideRuleBody",[]]]],Rule_extend:["define",{sourceInterval:[255,305]},null,[],["seq",{sourceInterval:[255,294]},["app",{sourceInterval:[255,260]},"ident",[]],["opt",{sourceInterval:[261,269]},["app",{sourceInterval:[261,268]},"Formals",[]]],["terminal",{sourceInterval:[281,285]},"+="],["app",{sourceInterval:[286,294]},"RuleBody",[]]]],Rule:["define",{sourceInterval:[120,305]},null,[],["alt",{sourceInterval:[131,305]},["app",{sourceInterval:[131,170]},"Rule_define",[]],["app",{sourceInterval:[188,235]},"Rule_override",[]],["app",{sourceInterval:[255,294]},"Rule_extend",[]]]],RuleBody:["define",{sourceInterval:[309,362]},null,[],["seq",{sourceInterval:[324,362]},["opt",{sourceInterval:[324,328]},["terminal",{sourceInterval:[324,327]},"|"]],["app",{sourceInterval:[329,362]},"NonemptyListOf",[["app",{sourceInterval:[344,356]},"TopLevelTerm",[]],["terminal",{sourceInterval:[358,361]},"|"]]]]],TopLevelTerm_inline:["define",{sourceInterval:[385,408]},null,[],["seq",{sourceInterval:[385,397]},["app",{sourceInterval:[385,388]},"Seq",[]],["app",{sourceInterval:[389,397]},"caseName",[]]]],TopLevelTerm:["define",{sourceInterval:[366,418]},null,[],["alt",{sourceInterval:[385,418]},["app",{sourceInterval:[385,397]},"TopLevelTerm_inline",[]],["app",{sourceInterval:[415,418]},"Seq",[]]]],OverrideRuleBody:["define",{sourceInterval:[422,491]},null,[],["seq",{sourceInterval:[445,491]},["opt",{sourceInterval:[445,449]},["terminal",{sourceInterval:[445,448]},"|"]],["app",{sourceInterval:[450,491]},"NonemptyListOf",[["app",{sourceInterval:[465,485]},"OverrideTopLevelTerm",[]],["terminal",{sourceInterval:[487,490]},"|"]]]]],OverrideTopLevelTerm_superSplice:["define",{sourceInterval:[522,543]},null,[],["terminal",{sourceInterval:[522,527]},"..."]],OverrideTopLevelTerm:["define",{sourceInterval:[495,562]},null,[],["alt",{sourceInterval:[522,562]},["app",{sourceInterval:[522,527]},"OverrideTopLevelTerm_superSplice",[]],["app",{sourceInterval:[550,562]},"TopLevelTerm",[]]]],Formals:["define",{sourceInterval:[566,606]},null,[],["seq",{sourceInterval:[580,606]},["terminal",{sourceInterval:[580,583]},"<"],["app",{sourceInterval:[584,602]},"ListOf",[["app",{sourceInterval:[591,596]},"ident",[]],["terminal",{sourceInterval:[598,601]},","]]],["terminal",{sourceInterval:[603,606]},">"]]],Params:["define",{sourceInterval:[610,647]},null,[],["seq",{sourceInterval:[623,647]},["terminal",{sourceInterval:[623,626]},"<"],["app",{sourceInterval:[627,643]},"ListOf",[["app",{sourceInterval:[634,637]},"Seq",[]],["terminal",{sourceInterval:[639,642]},","]]],["terminal",{sourceInterval:[644,647]},">"]]],Alt:["define",{sourceInterval:[651,685]},null,[],["app",{sourceInterval:[661,685]},"NonemptyListOf",[["app",{sourceInterval:[676,679]},"Seq",[]],["terminal",{sourceInterval:[681,684]},"|"]]]],Seq:["define",{sourceInterval:[689,704]},null,[],["star",{sourceInterval:[699,704]},["app",{sourceInterval:[699,703]},"Iter",[]]]],Iter_star:["define",{sourceInterval:[719,736]},null,[],["seq",{sourceInterval:[719,727]},["app",{sourceInterval:[719,723]},"Pred",[]],["terminal",{sourceInterval:[724,727]},"*"]]],Iter_plus:["define",{sourceInterval:[743,760]},null,[],["seq",{sourceInterval:[743,751]},["app",{sourceInterval:[743,747]},"Pred",[]],["terminal",{sourceInterval:[748,751]},"+"]]],Iter_opt:["define",{sourceInterval:[767,783]},null,[],["seq",{sourceInterval:[767,775]},["app",{sourceInterval:[767,771]},"Pred",[]],["terminal",{sourceInterval:[772,775]},"?"]]],Iter:["define",{sourceInterval:[708,794]},null,[],["alt",{sourceInterval:[719,794]},["app",{sourceInterval:[719,727]},"Iter_star",[]],["app",{sourceInterval:[743,751]},"Iter_plus",[]],["app",{sourceInterval:[767,775]},"Iter_opt",[]],["app",{sourceInterval:[790,794]},"Pred",[]]]],Pred_not:["define",{sourceInterval:[809,824]},null,[],["seq",{sourceInterval:[809,816]},["terminal",{sourceInterval:[809,812]},"~"],["app",{sourceInterval:[813,816]},"Lex",[]]]],Pred_lookahead:["define",{sourceInterval:[831,852]},null,[],["seq",{sourceInterval:[831,838]},["terminal",{sourceInterval:[831,834]},"&"],["app",{sourceInterval:[835,838]},"Lex",[]]]],Pred:["define",{sourceInterval:[798,862]},null,[],["alt",{sourceInterval:[809,862]},["app",{sourceInterval:[809,816]},"Pred_not",[]],["app",{sourceInterval:[831,838]},"Pred_lookahead",[]],["app",{sourceInterval:[859,862]},"Lex",[]]]],Lex_lex:["define",{sourceInterval:[876,892]},null,[],["seq",{sourceInterval:[876,884]},["terminal",{sourceInterval:[876,879]},"#"],["app",{sourceInterval:[880,884]},"Base",[]]]],Lex:["define",{sourceInterval:[866,903]},null,[],["alt",{sourceInterval:[876,903]},["app",{sourceInterval:[876,884]},"Lex_lex",[]],["app",{sourceInterval:[899,903]},"Base",[]]]],Base_application:["define",{sourceInterval:[918,979]},null,[],["seq",{sourceInterval:[918,963]},["app",{sourceInterval:[918,923]},"ident",[]],["opt",{sourceInterval:[924,931]},["app",{sourceInterval:[924,930]},"Params",[]]],["not",{sourceInterval:[932,963]},["alt",{sourceInterval:[934,962]},["seq",{sourceInterval:[934,948]},["opt",{sourceInterval:[934,944]},["app",{sourceInterval:[934,943]},"ruleDescr",[]]],["terminal",{sourceInterval:[945,948]},"="]],["terminal",{sourceInterval:[951,955]},":="],["terminal",{sourceInterval:[958,962]},"+="]]]]],Base_range:["define",{sourceInterval:[986,1041]},null,[],["seq",{sourceInterval:[986,1022]},["app",{sourceInterval:[986,1001]},"oneCharTerminal",[]],["terminal",{sourceInterval:[1002,1006]},".."],["app",{sourceInterval:[1007,1022]},"oneCharTerminal",[]]]],Base_terminal:["define",{sourceInterval:[1048,1106]},null,[],["app",{sourceInterval:[1048,1056]},"terminal",[]]],Base_paren:["define",{sourceInterval:[1113,1168]},null,[],["seq",{sourceInterval:[1113,1124]},["terminal",{sourceInterval:[1113,1116]},"("],["app",{sourceInterval:[1117,1120]},"Alt",[]],["terminal",{sourceInterval:[1121,1124]},")"]]],Base:["define",{sourceInterval:[907,1168]},null,[],["alt",{sourceInterval:[918,1168]},["app",{sourceInterval:[918,963]},"Base_application",[]],["app",{sourceInterval:[986,1022]},"Base_range",[]],["app",{sourceInterval:[1048,1056]},"Base_terminal",[]],["app",{sourceInterval:[1113,1124]},"Base_paren",[]]]],ruleDescr:["define",{sourceInterval:[1172,1231]},"a rule description",[],["seq",{sourceInterval:[1210,1231]},["terminal",{sourceInterval:[1210,1213]},"("],["app",{sourceInterval:[1214,1227]},"ruleDescrText",[]],["terminal",{sourceInterval:[1228,1231]},")"]]],ruleDescrText:["define",{sourceInterval:[1235,1266]},null,[],["star",{sourceInterval:[1255,1266]},["seq",{sourceInterval:[1256,1264]},["not",{sourceInterval:[1256,1260]},["terminal",{sourceInterval:[1257,1260]},")"]],["app",{sourceInterval:[1261,1264]},"any",[]]]]],caseName:["define",{sourceInterval:[1270,1338]},null,[],["seq",{sourceInterval:[1285,1338]},["terminal",{sourceInterval:[1285,1289]},"--"],["star",{sourceInterval:[1290,1304]},["seq",{sourceInterval:[1291,1302]},["not",{sourceInterval:[1291,1296]},["terminal",{sourceInterval:[1292,1296]},`
`]],["app",{sourceInterval:[1297,1302]},"space",[]]]],["app",{sourceInterval:[1305,1309]},"name",[]],["star",{sourceInterval:[1310,1324]},["seq",{sourceInterval:[1311,1322]},["not",{sourceInterval:[1311,1316]},["terminal",{sourceInterval:[1312,1316]},`
`]],["app",{sourceInterval:[1317,1322]},"space",[]]]],["alt",{sourceInterval:[1326,1337]},["terminal",{sourceInterval:[1326,1330]},`
`],["lookahead",{sourceInterval:[1333,1337]},["terminal",{sourceInterval:[1334,1337]},"}"]]]]],name:["define",{sourceInterval:[1342,1382]},"a name",[],["seq",{sourceInterval:[1363,1382]},["app",{sourceInterval:[1363,1372]},"nameFirst",[]],["star",{sourceInterval:[1373,1382]},["app",{sourceInterval:[1373,1381]},"nameRest",[]]]]],nameFirst:["define",{sourceInterval:[1386,1418]},null,[],["alt",{sourceInterval:[1402,1418]},["terminal",{sourceInterval:[1402,1405]},"_"],["app",{sourceInterval:[1412,1418]},"letter",[]]]],nameRest:["define",{sourceInterval:[1422,1452]},null,[],["alt",{sourceInterval:[1437,1452]},["terminal",{sourceInterval:[1437,1440]},"_"],["app",{sourceInterval:[1447,1452]},"alnum",[]]]],ident:["define",{sourceInterval:[1456,1489]},"an identifier",[],["app",{sourceInterval:[1485,1489]},"name",[]]],terminal:["define",{sourceInterval:[1493,1531]},null,[],["seq",{sourceInterval:[1508,1531]},["terminal",{sourceInterval:[1508,1512]},'"'],["star",{sourceInterval:[1513,1526]},["app",{sourceInterval:[1513,1525]},"terminalChar",[]]],["terminal",{sourceInterval:[1527,1531]},'"']]],oneCharTerminal:["define",{sourceInterval:[1535,1579]},null,[],["seq",{sourceInterval:[1557,1579]},["terminal",{sourceInterval:[1557,1561]},'"'],["app",{sourceInterval:[1562,1574]},"terminalChar",[]],["terminal",{sourceInterval:[1575,1579]},'"']]],terminalChar:["define",{sourceInterval:[1583,1660]},null,[],["alt",{sourceInterval:[1602,1660]},["app",{sourceInterval:[1602,1612]},"escapeChar",[]],["seq",{sourceInterval:[1621,1660]},["not",{sourceInterval:[1621,1626]},["terminal",{sourceInterval:[1622,1626]},"\\"]],["not",{sourceInterval:[1627,1632]},["terminal",{sourceInterval:[1628,1632]},'"']],["not",{sourceInterval:[1633,1638]},["terminal",{sourceInterval:[1634,1638]},`
`]],["range",{sourceInterval:[1639,1660]},"\0","\u{10FFFF}"]]]],escapeChar_backslash:["define",{sourceInterval:[1703,1758]},null,[],["terminal",{sourceInterval:[1703,1709]},"\\\\"]],escapeChar_doubleQuote:["define",{sourceInterval:[1765,1822]},null,[],["terminal",{sourceInterval:[1765,1771]},'\\"']],escapeChar_singleQuote:["define",{sourceInterval:[1829,1886]},null,[],["terminal",{sourceInterval:[1829,1835]},"\\'"]],escapeChar_backspace:["define",{sourceInterval:[1893,1948]},null,[],["terminal",{sourceInterval:[1893,1898]},"\\b"]],escapeChar_lineFeed:["define",{sourceInterval:[1955,2009]},null,[],["terminal",{sourceInterval:[1955,1960]},"\\n"]],escapeChar_carriageReturn:["define",{sourceInterval:[2016,2076]},null,[],["terminal",{sourceInterval:[2016,2021]},"\\r"]],escapeChar_tab:["define",{sourceInterval:[2083,2132]},null,[],["terminal",{sourceInterval:[2083,2088]},"\\t"]],escapeChar_unicodeCodePoint:["define",{sourceInterval:[2139,2243]},null,[],["seq",{sourceInterval:[2139,2221]},["terminal",{sourceInterval:[2139,2145]},"\\u{"],["app",{sourceInterval:[2146,2154]},"hexDigit",[]],["opt",{sourceInterval:[2155,2164]},["app",{sourceInterval:[2155,2163]},"hexDigit",[]]],["opt",{sourceInterval:[2165,2174]},["app",{sourceInterval:[2165,2173]},"hexDigit",[]]],["opt",{sourceInterval:[2188,2197]},["app",{sourceInterval:[2188,2196]},"hexDigit",[]]],["opt",{sourceInterval:[2198,2207]},["app",{sourceInterval:[2198,2206]},"hexDigit",[]]],["opt",{sourceInterval:[2208,2217]},["app",{sourceInterval:[2208,2216]},"hexDigit",[]]],["terminal",{sourceInterval:[2218,2221]},"}"]]],escapeChar_unicodeEscape:["define",{sourceInterval:[2250,2309]},null,[],["seq",{sourceInterval:[2250,2291]},["terminal",{sourceInterval:[2250,2255]},"\\u"],["app",{sourceInterval:[2256,2264]},"hexDigit",[]],["app",{sourceInterval:[2265,2273]},"hexDigit",[]],["app",{sourceInterval:[2274,2282]},"hexDigit",[]],["app",{sourceInterval:[2283,2291]},"hexDigit",[]]]],escapeChar_hexEscape:["define",{sourceInterval:[2316,2371]},null,[],["seq",{sourceInterval:[2316,2339]},["terminal",{sourceInterval:[2316,2321]},"\\x"],["app",{sourceInterval:[2322,2330]},"hexDigit",[]],["app",{sourceInterval:[2331,2339]},"hexDigit",[]]]],escapeChar:["define",{sourceInterval:[1664,2371]},"an escape sequence",[],["alt",{sourceInterval:[1703,2371]},["app",{sourceInterval:[1703,1709]},"escapeChar_backslash",[]],["app",{sourceInterval:[1765,1771]},"escapeChar_doubleQuote",[]],["app",{sourceInterval:[1829,1835]},"escapeChar_singleQuote",[]],["app",{sourceInterval:[1893,1898]},"escapeChar_backspace",[]],["app",{sourceInterval:[1955,1960]},"escapeChar_lineFeed",[]],["app",{sourceInterval:[2016,2021]},"escapeChar_carriageReturn",[]],["app",{sourceInterval:[2083,2088]},"escapeChar_tab",[]],["app",{sourceInterval:[2139,2221]},"escapeChar_unicodeCodePoint",[]],["app",{sourceInterval:[2250,2291]},"escapeChar_unicodeEscape",[]],["app",{sourceInterval:[2316,2339]},"escapeChar_hexEscape",[]]]],space:["extend",{sourceInterval:[2375,2394]},null,[],["app",{sourceInterval:[2387,2394]},"comment",[]]],comment_singleLine:["define",{sourceInterval:[2412,2458]},null,[],["seq",{sourceInterval:[2412,2443]},["terminal",{sourceInterval:[2412,2416]},"//"],["star",{sourceInterval:[2417,2429]},["seq",{sourceInterval:[2418,2427]},["not",{sourceInterval:[2418,2423]},["terminal",{sourceInterval:[2419,2423]},`
`]],["app",{sourceInterval:[2424,2427]},"any",[]]]],["lookahead",{sourceInterval:[2430,2443]},["alt",{sourceInterval:[2432,2442]},["terminal",{sourceInterval:[2432,2436]},`
`],["app",{sourceInterval:[2439,2442]},"end",[]]]]]],comment_multiLine:["define",{sourceInterval:[2465,2501]},null,[],["seq",{sourceInterval:[2465,2487]},["terminal",{sourceInterval:[2465,2469]},"/*"],["star",{sourceInterval:[2470,2482]},["seq",{sourceInterval:[2471,2480]},["not",{sourceInterval:[2471,2476]},["terminal",{sourceInterval:[2472,2476]},"*/"]],["app",{sourceInterval:[2477,2480]},"any",[]]]],["terminal",{sourceInterval:[2483,2487]},"*/"]]],comment:["define",{sourceInterval:[2398,2501]},null,[],["alt",{sourceInterval:[2412,2501]},["app",{sourceInterval:[2412,2443]},"comment_singleLine",[]],["app",{sourceInterval:[2465,2487]},"comment_multiLine",[]]]],tokens:["define",{sourceInterval:[2505,2520]},null,[],["star",{sourceInterval:[2514,2520]},["app",{sourceInterval:[2514,2519]},"token",[]]]],token:["define",{sourceInterval:[2524,2600]},null,[],["alt",{sourceInterval:[2532,2600]},["app",{sourceInterval:[2532,2540]},"caseName",[]],["app",{sourceInterval:[2543,2550]},"comment",[]],["app",{sourceInterval:[2553,2558]},"ident",[]],["app",{sourceInterval:[2561,2569]},"operator",[]],["app",{sourceInterval:[2572,2583]},"punctuation",[]],["app",{sourceInterval:[2586,2594]},"terminal",[]],["app",{sourceInterval:[2597,2600]},"any",[]]]],operator:["define",{sourceInterval:[2604,2669]},null,[],["alt",{sourceInterval:[2615,2669]},["terminal",{sourceInterval:[2615,2619]},"<:"],["terminal",{sourceInterval:[2622,2625]},"="],["terminal",{sourceInterval:[2628,2632]},":="],["terminal",{sourceInterval:[2635,2639]},"+="],["terminal",{sourceInterval:[2642,2645]},"*"],["terminal",{sourceInterval:[2648,2651]},"+"],["terminal",{sourceInterval:[2654,2657]},"?"],["terminal",{sourceInterval:[2660,2663]},"~"],["terminal",{sourceInterval:[2666,2669]},"&"]]],punctuation:["define",{sourceInterval:[2673,2709]},null,[],["alt",{sourceInterval:[2687,2709]},["terminal",{sourceInterval:[2687,2690]},"<"],["terminal",{sourceInterval:[2693,2696]},">"],["terminal",{sourceInterval:[2699,2702]},","],["terminal",{sourceInterval:[2705,2709]},"--"]]]}]);var ot=Object.create(h.prototype);function Ut(t,e){for(let r in t)if(r===e)return!0;return!1}function at(t,e,r){let n=new ee,i,s,a,o=!1;return(r||Se).createSemantics().addOperation("visit",{Grammars(c){return c.children.map(p=>p.visit())},Grammar(c,p,m,d,v){let E=c.visit();i=n.newGrammar(E),p.child(0)&&p.child(0).visit(),d.children.map(ne=>ne.visit());let C=i.build();if(C.source=this.source.trimmed(),Ut(e,E))throw vt(C,e);return e[E]=C,C},SuperGrammar(c,p){let m=p.visit();if(m==="null")i.withSuperGrammar(null);else{if(!e||!Ut(e,m))throw xt(m,e,p.source);i.withSuperGrammar(e[m])}},Rule_define(c,p,m,d,v){s=c.visit(),a=p.children.map(ue=>ue.visit())[0]||[],!i.defaultStartRule&&i.ensureSuperGrammar()!==R.ProtoBuiltInRules&&i.withDefaultStartRule(s);let E=v.visit(),C=m.children.map(ue=>ue.visit())[0],ne=this.source.trimmed();return i.define(s,a,E,C,ne)},Rule_override(c,p,m,d){s=c.visit(),a=p.children.map(C=>C.visit())[0]||[];let v=this.source.trimmed();i.ensureSuperGrammarRuleForOverriding(s,v),o=!0;let E=d.visit();return o=!1,i.override(s,a,E,null,v)},Rule_extend(c,p,m,d){s=c.visit(),a=p.children.map(C=>C.visit())[0]||[];let v=d.visit(),E=this.source.trimmed();return i.extend(s,a,v,null,E)},RuleBody(c,p){return n.alt(...p.visit()).withSource(this.source)},OverrideRuleBody(c,p){let m=p.visit(),d=m.indexOf(ot);if(d>=0){let v=m.slice(0,d),E=m.slice(d+1);return E.forEach(C=>{if(C===ot)throw kt(C)}),new J(i.superGrammar,s,v,E).withSource(this.source)}else return n.alt(...m).withSource(this.source)},Formals(c,p,m){return p.visit()},Params(c,p,m){return p.visit()},Alt(c){return n.alt(...c.visit()).withSource(this.source)},TopLevelTerm_inline(c,p){let m=s+"_"+p.visit(),d=c.visit(),v=this.source.trimmed(),E=!(i.superGrammar&&i.superGrammar.rules[m]);o&&!E?i.override(m,a,d,null,v):i.define(m,a,d,null,v);let C=a.map(ne=>n.app(ne));return n.app(m,C).withSource(d.source)},OverrideTopLevelTerm_superSplice(c){return ot},Seq(c){return n.seq(...c.children.map(p=>p.visit())).withSource(this.source)},Iter_star(c,p){return n.star(c.visit()).withSource(this.source)},Iter_plus(c,p){return n.plus(c.visit()).withSource(this.source)},Iter_opt(c,p){return n.opt(c.visit()).withSource(this.source)},Pred_not(c,p){return n.not(p.visit()).withSource(this.source)},Pred_lookahead(c,p){return n.lookahead(p.visit()).withSource(this.source)},Lex_lex(c,p){return n.lex(p.visit()).withSource(this.source)},Base_application(c,p){let m=p.children.map(d=>d.visit())[0]||[];return n.app(c.visit(),m).withSource(this.source)},Base_range(c,p,m){return n.range(c.visit(),m.visit()).withSource(this.source)},Base_terminal(c){return n.terminal(c.visit()).withSource(this.source)},Base_paren(c,p,m){return p.visit()},ruleDescr(c,p,m){return p.visit()},ruleDescrText(c){return this.sourceString.trim()},caseName(c,p,m,d,v){return m.visit()},name(c,p){return this.sourceString},nameFirst(c){},nameRest(c){},terminal(c,p,m){return p.children.map(d=>d.visit()).join("")},oneCharTerminal(c,p,m){return p.visit()},escapeChar(c){try{return We(this.sourceString)}catch(p){throw p instanceof RangeError&&p.message.startsWith("Invalid code point ")?Lt(c):p}},NonemptyListOf(c,p,m){return[c.visit()].concat(m.children.map(d=>d.visit()))},EmptyListOf(){return[]},_terminal(){return this.sourceString}})(t).visit()}var Ht=se(["grammar",{source:`OperationsAndAttributes {

  AttributeSignature =
    name

  OperationSignature =
    name Formals?

  Formals
    = "(" ListOf<name, ","> ")"

  name  (a name)
    = nameFirst nameRest*

  nameFirst
    = "_"
    | letter

  nameRest
    = "_"
    | alnum

}`},"OperationsAndAttributes",null,"AttributeSignature",{AttributeSignature:["define",{sourceInterval:[29,58]},null,[],["app",{sourceInterval:[54,58]},"name",[]]],OperationSignature:["define",{sourceInterval:[62,100]},null,[],["seq",{sourceInterval:[87,100]},["app",{sourceInterval:[87,91]},"name",[]],["opt",{sourceInterval:[92,100]},["app",{sourceInterval:[92,99]},"Formals",[]]]]],Formals:["define",{sourceInterval:[104,143]},null,[],["seq",{sourceInterval:[118,143]},["terminal",{sourceInterval:[118,121]},"("],["app",{sourceInterval:[122,139]},"ListOf",[["app",{sourceInterval:[129,133]},"name",[]],["terminal",{sourceInterval:[135,138]},","]]],["terminal",{sourceInterval:[140,143]},")"]]],name:["define",{sourceInterval:[147,187]},"a name",[],["seq",{sourceInterval:[168,187]},["app",{sourceInterval:[168,177]},"nameFirst",[]],["star",{sourceInterval:[178,187]},["app",{sourceInterval:[178,186]},"nameRest",[]]]]],nameFirst:["define",{sourceInterval:[191,223]},null,[],["alt",{sourceInterval:[207,223]},["terminal",{sourceInterval:[207,210]},"_"],["app",{sourceInterval:[217,223]},"letter",[]]]],nameRest:["define",{sourceInterval:[227,257]},null,[],["alt",{sourceInterval:[242,257]},["terminal",{sourceInterval:[242,245]},"_"],["app",{sourceInterval:[252,257]},"alnum",[]]]]}]);qr(R.BuiltInRules);Ur(Ht);function qr(t){let e={empty(){return this.iteration()},nonEmpty(r,n,i){return this.iteration([r].concat(i.children))},self(...r){return this}};B.BuiltInSemantics=B.createSemantics(t,null).addOperation("asIteration",{emptyListOf:e.empty,nonemptyListOf:e.nonEmpty,EmptyListOf:e.empty,NonemptyListOf:e.nonEmpty,_iter:e.self})}function Ur(t){B.prototypeGrammarSemantics=t.createSemantics().addOperation("parse",{AttributeSignature(e){return{name:e.parse(),formals:[]}},OperationSignature(e,r){return{name:e.parse(),formals:r.children.map(n=>n.parse())[0]||[]}},Formals(e,r,n){return r.asIteration().children.map(i=>i.parse())},name(e,r){return this.sourceString}}),B.prototypeGrammar=t}function Kt(t){let e=0,r=[0],n=()=>r[r.length-1],i={},s=/( *).*(?:$|\r?\n|\r)/g,a;for(;(a=s.exec(t))!=null;){let[o,l]=a;if(o.length===0)break;let u=l.length,c=n(),p=e+u;if(u>c)r.push(u),i[p]=1;else if(u<c){let m=r.length;for(;n()!==u;)r.pop();i[p]=-1*(m-r.length)}e+=o.length}return r.length>1&&(i[e]=1-r.length),i}var Wt="an indented block",Vt="a dedent",zt=1114112,lt=class extends Q{constructor(e){super(e.input),this.state=e}_indentationAt(e){return this.state.userData[e]||0}atEnd(){return super.atEnd()&&this._indentationAt(this.pos)===0}next(){if(this._indentationAt(this.pos)!==0){this.examinedLength=Math.max(this.examinedLength,this.pos);return}return super.next()}nextCharCode(){return this._indentationAt(this.pos)!==0?(this.examinedLength=Math.max(this.examinedLength,this.pos),zt):super.nextCharCode()}nextCodePoint(){return this._indentationAt(this.pos)!==0?(this.examinedLength=Math.max(this.examinedLength,this.pos),zt):super.nextCodePoint()}},$e=class extends h{constructor(e=!0){super(),this.isIndent=e}allowsSkippingPrecedingSpace(){return!0}eval(e){let{inputStream:r}=e,n=e.userData;e.doNotMemoize=!0;let i=r.pos,s=this.isIndent?1:-1;return(n[i]||0)*s>0?(e.userData=Object.create(n),e.userData[i]-=s,e.pushBinding(new q(0),i),!0):(e.processFailure(i,this),!1)}getArity(){return 1}_assertAllApplicationsAreValid(e,r){}_isNullable(e,r){return!1}assertChoicesHaveUniformArity(e){}assertIteratedExprsAreNotNullable(e){}introduceParams(e){return this}substituteParams(e){return this}toString(){return this.isIndent?"indent":"dedent"}toDisplayString(){return this.toString()}toFailure(e){let r=this.isIndent?Wt:Vt;return new F(this,r,"description")}},Hr=new f("indent"),Kr=new f("dedent"),zr=new J(Ie,"any",[Hr,Kr],[]),Xt=new ee().newGrammar("IndentationSensitive").withSuperGrammar(Ie).define("indent",[],new $e(!0),Wt,void 0,!0).define("dedent",[],new $e(!1),Vt,void 0,!0).extend("any",[],zr,"any character",void 0).build();Object.assign(Xt,{_matchStateInitializer(t){t.userData=Kt(t.input),t.inputStream=new lt(t)},supportsIncrementalParsing:!1});R.initApplicationParser(Se,at);var Wr=t=>!!t.constructor&&typeof t.constructor.isBuffer=="function"&&t.constructor.isBuffer(t);function Vr(t,e){let r=Se.match(t,"Grammars");if(r.failed())throw yt(r);return at(r,e)}function Jt(t,e){let r=Xr(t,e),n=Object.keys(r);if(n.length===0)throw new Error("Missing grammar definition");if(n.length>1){let s=r[n[1]].source;throw new Error(ae(s.sourceString,s.startIdx)+"Found more than one grammar definition -- use ohm.grammars() instead.")}return r[n[0]]}function Xr(t,e){let r=Object.create(e||{});if(typeof t!="string")if(Wr(t))t=t.toString();else throw new TypeError("Expected string as first argument, got "+me(t));return Vr(t,r),r}var Yt=`PlatformerDSL {
  // \u2500\u2500\u2500 Top-Level \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500

  Game = "game" string "{" GameBlock+ "}"

  GameBlock = ConfigBlock
            | AssetsBlock
            | PlayerBlock
            | EnemyBlock
            | CollectibleBlock
            | LevelBlock
            | HudBlock
            | RulesBlock
            | SoundsBlock

  // \u2500\u2500\u2500 Config \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500

  ConfigBlock = "config" "{" ConfigProp ("," ConfigProp)* ","? "}"

  ConfigProp = "width" ":" number        -- width
             | "height" ":" number       -- height
             | "gravity" ":" number      -- gravity
             | "background" ":" color    -- background

  // \u2500\u2500\u2500 Assets \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500

  AssetsBlock = "assets" "{" AssetDef+ "}"

  AssetDef = "spritesheet" ident string SpritesheetConfig  -- spritesheet
           | "image" ident string                          -- image
           | "tilemap" ident string                        -- tilemap
           | "audio" ident string                          -- audio

  SpritesheetConfig = "{" "frameWidth" ":" number "," "frameHeight" ":" number ","? "}"

  // \u2500\u2500\u2500 Player \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500

  PlayerBlock = "player" "{" PlayerProp (","? PlayerProp)* ","? "}"

  PlayerProp = "sprite" ":" ident                     -- sprite
             | "speed" ":" number                     -- speed
             | "jumpForce" ":" number                 -- jumpForce
             | "lives" ":" number                     -- lives
             | "controls" ":" controlScheme           -- controls
             | AnimationBlock                         -- animation

  controlScheme = "arrows" | "wasd" | "both"

  // \u2500\u2500\u2500 Enemies \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500

  EnemyBlock = "enemy" ident "{" EnemyProp (","? EnemyProp)* ","? "}"

  EnemyProp = "sprite" ":" ident              -- sprite
            | "movement" ":" MovementDef      -- movement
            | "damage" ":" number             -- damage
            | "stompable" ":" boolean         -- stompable
            | AnimationBlock                  -- animation

  MovementDef = "patrol" "{" MovementParam ("," MovementParam)* ","? "}"  -- patrol
              | "chase" "{" MovementParam ("," MovementParam)* ","? "}"   -- chase
              | "fly" "{" MovementParam ("," MovementParam)* ","? "}"     -- fly
              | "static"                                                   -- static

  MovementParam = "speed" ":" number       -- speed
                | "distance" ":" number    -- distance
                | "range" ":" number       -- range
                | "amplitude" ":" number   -- amplitude
                | "frequency" ":" number   -- frequency

  // \u2500\u2500\u2500 Collectibles \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500

  CollectibleBlock = "collectible" ident "{" CollectibleProp (","? CollectibleProp)* ","? "}"

  CollectibleProp = "sprite" ":" ident              -- sprite
                  | "score" ":" number              -- score
                  | "effect" ":" collectibleEffect  -- effect
                  | AnimationBlock                  -- animation

  collectibleEffect = "extraLife" | "speedBoost" | "invincible" | "none"

  // \u2500\u2500\u2500 Levels \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500

  LevelBlock = "level" string "{" LevelProp+ "}"

  LevelProp = "tilemap" ":" ident                                   -- tilemap
            | "layers" ":" "{" LayerMapping ("," LayerMapping)* ","? "}"  -- layers
            | "spawn" ":" "{" "x" ":" number "," "y" ":" number "}"      -- spawn
            | "enemies" ":" "[" ListOf<EntityPlacement, ","> "]"         -- enemies
            | "coins" ":" "[" ListOf<EntityPlacement, ","> "]"           -- coins
            | "platforms" ":" "[" ListOf<PlatformPlacement, ","> "]"     -- platforms
            | "exit" ":" "{" "x" ":" number "," "y" ":" number "}"       -- exit

  LayerMapping = ident ":" string

  EntityPlacement = ident "at" "(" number "," number ")"

  PlatformPlacement = ident "at" "(" number "," number "," number "," number ")"

  // \u2500\u2500\u2500 HUD \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500

  HudBlock = "hud" "{" HudElement+ "}"

  HudElement = hudType "{" HudProp ("," HudProp)* ","? "}"

  hudType = "score" | "lives" | "timer"

  HudProp = "position" ":" hudPosition    -- position
          | "fontSize" ":" number         -- fontSize
          | "color" ":" color             -- color
          | "max" ":" number              -- max

  hudPosition = "top-left" | "top-right" | "top-center"
              | "bottom-left" | "bottom-right" | "bottom-center"

  // \u2500\u2500\u2500 Rules \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500

  RulesBlock = "rules" "{" RuleProp ("," RuleProp)* ","? "}"

  RuleProp = "win" ":" WinCondition        -- win
           | "lose" ":" LoseCondition      -- lose
           | "nextLevel" ":" string        -- nextLevel

  WinCondition = "reachExit"                          -- reachExit
               | "collectAll" ident                   -- collectAll
               | "defeatAll"                          -- defeatAll
               | "survive" number                     -- survive

  LoseCondition = "noLives"        -- noLives
                | "timerExpires"    -- timerExpires
                | "fallOff"        -- fallOff

  // \u2500\u2500\u2500 Sounds \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500

  SoundsBlock = "sounds" "{" SoundProp (","? SoundProp)* ","? "}"

  SoundProp = "jump" ":" ident      -- jump
            | "collect" ":" ident   -- collect
            | "hurt" ":" ident      -- hurt
            | "win" ":" ident       -- win
            | "lose" ":" ident      -- lose
            | "bgm" ":" ident       -- bgm

  // \u2500\u2500\u2500 Animations \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500

  AnimationBlock = "animation" ident "{" AnimProp ("," AnimProp)* ","? "}"

  AnimProp = "frames" ":" "[" ListOf<number, ","> "]"  -- frames
           | "fps" ":" number                          -- fps
           | "loop" ":" boolean                        -- loop

  // \u2500\u2500\u2500 Lexical Rules \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500

  ident = ~reserved letter (alnum | "_")*

  reserved = ("game" | "config" | "assets" | "player" | "enemy"
            | "collectible" | "level" | "hud" | "rules" | "sounds"
            | "animation" | "true" | "false" | "at"
            | "spritesheet" | "image" | "tilemap" | "audio"
            | "patrol" | "chase" | "fly" | "static"
            | "reachExit" | "collectAll" | "defeatAll" | "survive"
            | "noLives" | "timerExpires" | "fallOff"
            | "extraLife" | "speedBoost" | "invincible" | "none"
            | "arrows" | "wasd" | "both"
            | "score" | "lives" | "timer") ~(alnum | "_")

  string = "\\"" stringChar* "\\""
  stringChar = escapeChar | normalChar
  escapeChar = "\\\\" any
  normalChar = ~("\\"" | "\\\\") any

  number = "-"? digit+ ("." digit+)?

  boolean = "true" | "false"

  color = "#" hexDigit hexDigit hexDigit hexDigit hexDigit hexDigit

  // \u2500\u2500\u2500 Whitespace & Comments \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500

  space += comment

  comment = "//" (~"\\n" any)* &("\\n" | end)   -- singleLine
          | "/*" (~"*/" any)* "*/"             -- multiLine
}
`;var je=Jt(Yt);var ct=class extends Error{constructor(r,n,i){super(`[${n}] ${r}`);this.phase=n;this.details=i;this.name="DSLError"}},Ge=class extends ct{constructor(e,r){super(e,"parse",r),this.name="ParseError"}};function Yr(t){let e=je.match(t);return e.failed()?{match:e,succeeded:!1,message:e.message}:{match:e,succeeded:!0}}function Zt(t){let e=Yr(t);if(!e.succeeded)throw new Ge("Failed to parse DSL source",e.message);return e.match}var Qt=je.createSemantics();function U(t){let e={};for(let r of t){let n=r.toAST();for(let[i,s]of Object.entries(n))Array.isArray(s)&&Array.isArray(e[i])?e[i]=[...e[i],...s]:e[i]=s}return e}Qt.addOperation("toAST",{Game(t,e,r,n,i){let s=e.toAST(),a={},o=[],l,u=[],c=[],p=[],m,d,v;for(let E of n.children){let C=E.toAST();switch(C.__block){case"config":a=C.value;break;case"assets":o.push(...C.value);break;case"player":l=C.value;break;case"enemy":u.push(C.value);break;case"collectible":c.push(C.value);break;case"level":p.push(C.value);break;case"hud":m=C.value;break;case"rules":d=C.value;break;case"sounds":v=C.value;break}}return{title:s,config:a,assets:o,player:l,enemies:u,collectibles:c,levels:p,hud:m,rules:d,sounds:v}},GameBlock(t){return t.toAST()},ConfigBlock(t,e,r,n,i,s,a){return{__block:"config",value:U([r,...i.children])}},ConfigProp_width(t,e,r){return{width:r.toAST()}},ConfigProp_height(t,e,r){return{height:r.toAST()}},ConfigProp_gravity(t,e,r){return{gravity:r.toAST()}},ConfigProp_background(t,e,r){return{background:r.toAST()}},AssetsBlock(t,e,r,n){return{__block:"assets",value:r.children.map(s=>s.toAST())}},AssetDef_spritesheet(t,e,r,n){return{type:"spritesheet",key:e.toAST(),path:r.toAST(),config:n.toAST()}},AssetDef_image(t,e,r){return{type:"image",key:e.toAST(),path:r.toAST()}},AssetDef_tilemap(t,e,r){return{type:"tilemap",key:e.toAST(),path:r.toAST()}},AssetDef_audio(t,e,r){return{type:"audio",key:e.toAST(),path:r.toAST()}},SpritesheetConfig(t,e,r,n,i,s,a,o,l,u){return{frameWidth:n.toAST(),frameHeight:o.toAST()}},PlayerBlock(t,e,r,n,i,s,a){let o=U([r,...i.children]),l=o.animations||[];return delete o.animations,{__block:"player",value:{...o,animations:l}}},PlayerProp_sprite(t,e,r){return{sprite:r.toAST()}},PlayerProp_speed(t,e,r){return{speed:r.toAST()}},PlayerProp_jumpForce(t,e,r){return{jumpForce:r.toAST()}},PlayerProp_lives(t,e,r){return{lives:r.toAST()}},PlayerProp_controls(t,e,r){return{controls:r.toAST()}},PlayerProp_animation(t){return{animations:[t.toAST()]}},EnemyBlock(t,e,r,n,i,s,a,o){let l=U([n,...s.children]),u=l.animations||[];return delete l.animations,{__block:"enemy",value:{name:e.toAST(),...l,animations:u}}},EnemyProp_sprite(t,e,r){return{sprite:r.toAST()}},EnemyProp_movement(t,e,r){return{movement:r.toAST()}},EnemyProp_damage(t,e,r){return{damage:r.toAST()}},EnemyProp_stompable(t,e,r){return{stompable:r.toAST()}},EnemyProp_animation(t){return{animations:[t.toAST()]}},MovementDef_patrol(t,e,r,n,i,s,a){return{kind:"patrol",...U([r,...i.children])}},MovementDef_chase(t,e,r,n,i,s,a){return{kind:"chase",...U([r,...i.children])}},MovementDef_fly(t,e,r,n,i,s,a){return{kind:"fly",...U([r,...i.children])}},MovementDef_static(t){return{kind:"static"}},MovementParam_speed(t,e,r){return{speed:r.toAST()}},MovementParam_distance(t,e,r){return{distance:r.toAST()}},MovementParam_range(t,e,r){return{range:r.toAST()}},MovementParam_amplitude(t,e,r){return{amplitude:r.toAST()}},MovementParam_frequency(t,e,r){return{frequency:r.toAST()}},CollectibleBlock(t,e,r,n,i,s,a,o){let l=U([n,...s.children]),u=l.animations||[];return delete l.animations,{__block:"collectible",value:{name:e.toAST(),effect:"none",...l,animations:u}}},CollectibleProp_sprite(t,e,r){return{sprite:r.toAST()}},CollectibleProp_score(t,e,r){return{score:r.toAST()}},CollectibleProp_effect(t,e,r){return{effect:r.toAST()}},CollectibleProp_animation(t){return{animations:[t.toAST()]}},LevelBlock(t,e,r,n,i){let s=U(n.children);return{__block:"level",value:{name:e.toAST(),enemies:[],collectibles:[],platforms:[],...s}}},LevelProp_tilemap(t,e,r){return{tilemap:r.toAST()}},LevelProp_layers(t,e,r,n,i,s,a,o){let l={},u=n.toAST();l[u[0]]=u[1];for(let c of s.children){let p=c.toAST();l[p[0]]=p[1]}return{layers:l}},LevelProp_spawn(t,e,r,n,i,s,a,o,l,u,c){return{spawn:{x:s.toAST(),y:u.toAST()}}},LevelProp_enemies(t,e,r,n,i){return{enemies:n.toAST()}},LevelProp_coins(t,e,r,n,i){return{collectibles:n.toAST()}},LevelProp_platforms(t,e,r,n,i){return{platforms:n.toAST()}},LevelProp_exit(t,e,r,n,i,s,a,o,l,u,c){return{exit:{x:s.toAST(),y:u.toAST()}}},LayerMapping(t,e,r){return[t.toAST(),r.toAST()]},EntityPlacement(t,e,r,n,i,s,a){return{entity:t.toAST(),x:n.toAST(),y:s.toAST()}},PlatformPlacement(t,e,r,n,i,s,a,o,l,u,c){return{asset:t.toAST(),x:n.toAST(),y:s.toAST(),width:o.toAST(),height:u.toAST()}},HudBlock(t,e,r,n){return{__block:"hud",value:{elements:r.children.map(i=>i.toAST())}}},HudElement(t,e,r,n,i,s,a){let o=U([r,...i.children]);return{type:t.toAST(),...o}},hudType(t){return this.sourceString},HudProp_position(t,e,r){return{position:r.toAST()}},HudProp_fontSize(t,e,r){return{fontSize:r.toAST()}},HudProp_color(t,e,r){return{color:r.toAST()}},HudProp_max(t,e,r){return{max:r.toAST()}},hudPosition(t){return this.sourceString},RulesBlock(t,e,r,n,i,s,a){return{__block:"rules",value:U([r,...i.children])}},RuleProp_win(t,e,r){return{win:r.toAST()}},RuleProp_lose(t,e,r){return{lose:r.toAST()}},RuleProp_nextLevel(t,e,r){return{nextLevel:r.toAST()}},WinCondition_reachExit(t){return{kind:"reachExit"}},WinCondition_collectAll(t,e){return{kind:"collectAll",entity:e.toAST()}},WinCondition_defeatAll(t){return{kind:"defeatAll"}},WinCondition_survive(t,e){return{kind:"survive",seconds:e.toAST()}},LoseCondition_noLives(t){return{kind:"noLives"}},LoseCondition_timerExpires(t){return{kind:"timerExpires"}},LoseCondition_fallOff(t){return{kind:"fallOff"}},SoundsBlock(t,e,r,n,i,s,a){return{__block:"sounds",value:U([r,...i.children])}},SoundProp_jump(t,e,r){return{jump:r.toAST()}},SoundProp_collect(t,e,r){return{collect:r.toAST()}},SoundProp_hurt(t,e,r){return{hurt:r.toAST()}},SoundProp_win(t,e,r){return{win:r.toAST()}},SoundProp_lose(t,e,r){return{lose:r.toAST()}},SoundProp_bgm(t,e,r){return{bgm:r.toAST()}},AnimationBlock(t,e,r,n,i,s,a,o){let l=U([n,...s.children]);return{name:e.toAST(),loop:!1,...l}},AnimProp_frames(t,e,r,n,i){return{frames:n.toAST()}},AnimProp_fps(t,e,r){return{fps:r.toAST()}},AnimProp_loop(t,e,r){return{loop:r.toAST()}},ident(t,e){return this.sourceString},string(t,e,r){return e.sourceString},stringChar(t){return t.sourceString},escapeChar(t,e){return e.sourceString},normalChar(t){return t.sourceString},number(t,e,r,n){return parseFloat(this.sourceString)},boolean(t){return t.sourceString==="true"},color(t,e,r,n,i,s,a){return this.sourceString},controlScheme(t){return this.sourceString},collectibleEffect(t){return this.sourceString},NonemptyListOf(t,e,r){return[t.toAST(),...r.children.map(n=>n.toAST())]},EmptyListOf(){return[]},_iter(...t){return t.map(e=>e.toAST())},_terminal(){return this.sourceString}});function er(t){return Qt(t).toAST()}function tr(t){let e=[];t.title||e.push("Game must have a title"),(!t.levels||t.levels.length===0)&&e.push("Game must define at least one level"),t.player||e.push("Game must define a player block");let r=new Set((t.assets??[]).map(a=>a.key));t.player?.sprite&&r.size>0&&!r.has(t.player.sprite)&&e.push(`Player references undefined asset: "${t.player.sprite}"`);let n=new Set((t.enemies??[]).map(a=>a.name)),i=new Set((t.collectibles??[]).map(a=>a.name));for(let a of t.enemies??[])r.size>0&&!r.has(a.sprite)&&e.push(`Enemy "${a.name}" references undefined asset: "${a.sprite}"`);for(let a of t.collectibles??[])r.size>0&&!r.has(a.sprite)&&e.push(`Collectible "${a.name}" references undefined asset: "${a.sprite}"`);let s=new Set;for(let a of t.levels??[]){s.has(a.name)&&e.push(`Duplicate level name: "${a.name}"`),s.add(a.name),a.tilemap&&r.size>0&&!r.has(a.tilemap)&&e.push(`Level "${a.name}" references undefined tilemap: "${a.tilemap}"`);for(let o of a.enemies??[])n.has(o.entity)||e.push(`Level "${a.name}" places undefined enemy: "${o.entity}"`);for(let o of a.collectibles??[])i.has(o.entity)||e.push(`Level "${a.name}" places undefined collectible: "${o.entity}"`);a.tilemap&&(!a.layers||Object.keys(a.layers).length===0)&&e.push(`Level "${a.name}" has a tilemap but no layers defined`)}if(t.rules?.nextLevel&&!s.has(t.rules.nextLevel)&&e.push(`Rules reference undefined next level: "${t.rules.nextLevel}"`),t.rules?.win?.kind==="collectAll"&&(i.has(t.rules.win.entity)||e.push(`Win condition "collectAll" references undefined collectible: "${t.rules.win.entity}"`)),t.sounds)for(let[a,o]of Object.entries(t.sounds))o&&r.size>0&&!r.has(o)&&e.push(`Sound "${a}" references undefined asset: "${o}"`);return{valid:e.length===0,errors:e}}var _e={width:800,height:600,gravity:500,background:"#87CEEB"},Ne={speed:160,jumpForce:330,lives:3,controls:"arrows"};function rr(t){return{title:t.title??"Untitled Game",config:Zr(t.config),assets:t.assets??[],player:Qr(t.player),enemies:(t.enemies??[]).map(en),collectibles:(t.collectibles??[]).map(tn),levels:t.levels??[],hud:t.hud,rules:t.rules??{win:{kind:"reachExit"},lose:{kind:"noLives"}},sounds:t.sounds}}function Zr(t){return{width:t?.width??_e.width,height:t?.height??_e.height,gravity:t?.gravity??_e.gravity,background:t?.background??_e.background}}function Qr(t){return{sprite:t?.sprite??"player",speed:t?.speed??Ne.speed,jumpForce:t?.jumpForce??Ne.jumpForce,lives:t?.lives??Ne.lives,controls:t?.controls??Ne.controls,animations:t?.animations??[]}}function en(t){return{name:t.name??"enemy",sprite:t.sprite??"enemy",movement:t.movement??{kind:"static"},damage:t.damage??1,stompable:t.stompable??!1,animations:t.animations??[]}}function tn(t){return{name:t.name??"item",sprite:t.sprite??"item",score:t.score??10,effect:t.effect??"none",animations:t.animations??[]}}var T=class{constructor(){this.lines=[];this.indentLevel=0;this.indentStr="  "}indent(){return this.indentLevel++,this}dedent(){return this.indentLevel=Math.max(0,this.indentLevel-1),this}line(e=""){return e===""?this.lines.push(""):this.lines.push(this.indentStr.repeat(this.indentLevel)+e),this}block(e,r){return this.line(`${e} {`),this.indent(),r(this),this.dedent(),this.line("}"),this}raw(e){for(let r of e.split(`
`))this.lines.push(r);return this}append(e){for(let r of e.lines)this.lines.push(this.indentStr.repeat(this.indentLevel)+r);return this}toString(){return this.lines.join(`
`)}};function nr(t,e=""){return t.path.startsWith("http://")||t.path.startsWith("https://")?t.path:e?`${e}/${t.path}`:t.path}function ir(t){let e=new T;return e.block("class BootScene extends Phaser.Scene",r=>{r.block("constructor()",n=>{n.line("super({ key: 'BootScene' });")}),r.line(),r.block("preload()",n=>{for(let i of t.assets){let s=nr(i);switch(i.type){case"image":n.line(`this.load.image('${i.key}', '${s}');`);break;case"spritesheet":n.line(`this.load.spritesheet('${i.key}', '${s}', { frameWidth: ${i.config.frameWidth}, frameHeight: ${i.config.frameHeight} });`);break;case"tilemap":n.line(`this.load.tilemapTiledJSON('${i.key}', '${s}');`);break;case"audio":n.line(`this.load.audio('${i.key}', '${s}');`);break}}}),r.line(),r.block("create()",n=>{let i=nn(t);for(let{ownerKey:s,anim:a}of i)n.line("this.anims.create({"),n.indent(),n.line(`key: '${s}_${a.name}',`),n.line(`frames: this.anims.generateFrameNumbers('${s}', { frames: [${a.frames.join(", ")}] }),`),n.line(`frameRate: ${a.fps},`),n.line(`repeat: ${a.loop?-1:0},`),n.dedent(),n.line("});");if(n.line(),t.levels.length>0){let s=rn(t.levels[0].name);n.line(`this.scene.start('${s}');`)}})}),e.toString()}function rn(t){return"Level_"+t.replace(/[^a-zA-Z0-9]/g,"_")}function nn(t){let e=[];for(let r of t.player.animations)e.push({ownerKey:t.player.sprite,anim:r});for(let r of t.enemies)for(let n of r.animations)e.push({ownerKey:r.sprite,anim:n});for(let r of t.collectibles)for(let n of r.animations)e.push({ownerKey:r.sprite,anim:n});return e}function sr(t,e){let r=new T;return r.line(`this.player = this.physics.add.sprite(${e.x}, ${e.y}, '${t.sprite}');`),r.line("this.player.setCollideWorldBounds(true);"),r.line("this.player.setBounce(0.1);"),r.toString()}function or(t){let e=new T,r=t.controls==="arrows"||t.controls==="both",n=t.controls==="wasd"||t.controls==="both";r&&e.line("const cursors = this.cursors;"),n&&e.line("const wasd = this.wasd;"),e.line(),e.line(`const speed = ${t.speed};`),e.line("this.player.setVelocityX(0);"),e.line();let i=[],s=[];r&&(i.push("cursors.left.isDown"),s.push("cursors.right.isDown")),n&&(i.push("wasd.left.isDown"),s.push("wasd.right.isDown")),e.block(`if (${i.join(" || ")})`,o=>{o.line("this.player.setVelocityX(-speed);"),o.line("this.player.setFlipX(true);"),t.animations.find(l=>l.name==="walk")&&o.line(`if (this.player.body.onFloor()) this.player.anims.play('${t.sprite}_walk', true);`)}),e.block(`else if (${s.join(" || ")})`,o=>{o.line("this.player.setVelocityX(speed);"),o.line("this.player.setFlipX(false);"),t.animations.find(l=>l.name==="walk")&&o.line(`if (this.player.body.onFloor()) this.player.anims.play('${t.sprite}_walk', true);`)}),e.block("else",o=>{o.line("this.player.anims.stop();")}),e.line();let a=[];return r&&a.push("cursors.up.isDown"),n&&a.push("wasd.up.isDown"),e.block(`if ((${a.join(" || ")}) && this.player.body.onFloor())`,o=>{o.line(`this.player.setVelocityY(-${t.jumpForce});`),t.animations.find(l=>l.name==="jump")&&o.line(`this.player.anims.play('${t.sprite}_jump', true);`),o.line("if (this.jumpSound) this.jumpSound.play();")}),e.toString()}function ar(t){let e=new T;return(t.controls==="arrows"||t.controls==="both")&&e.line("this.cursors = this.input.keyboard.createCursorKeys();"),(t.controls==="wasd"||t.controls==="both")&&(e.line("this.wasd = {"),e.indent(),e.line("up: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W),"),e.line("down: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S),"),e.line("left: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A),"),e.line("right: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D),"),e.dedent(),e.line("};")),e.toString()}function lr(t,e){let r=new T;if(e.length===0)return"";r.line("this.enemies = this.physics.add.group({ allowGravity: true });"),r.line();for(let n of e){let i=t.find(s=>s.name===n.entity);if(i){switch(r.line("{"),r.indent(),r.line(`const enemy = this.enemies.create(${n.x}, ${n.y}, '${i.sprite}');`),r.line("enemy.setBounce(0);"),r.line("enemy.setCollideWorldBounds(true);"),r.line(`enemy.enemyDef = ${JSON.stringify({name:i.name,movement:i.movement,damage:i.damage,stompable:i.stompable})};`),i.movement.kind){case"patrol":r.line(`enemy.setVelocityX(${i.movement.speed});`),r.line(`enemy.patrolOriginX = ${n.x};`),r.line(`enemy.patrolDistance = ${i.movement.distance};`),r.line(`enemy.patrolSpeed = ${i.movement.speed};`);break;case"chase":r.line(`enemy.chaseSpeed = ${i.movement.speed};`),r.line(`enemy.chaseRange = ${i.movement.range};`);break;case"fly":r.line("enemy.body.allowGravity = false;"),r.line(`enemy.flyOriginY = ${n.y};`),r.line(`enemy.flySpeed = ${i.movement.speed};`),r.line(`enemy.flyAmplitude = ${i.movement.amplitude};`),r.line(`enemy.flyFrequency = ${i.movement.frequency};`),r.line(`enemy.setVelocityX(${i.movement.speed});`);break;case"static":r.line("enemy.body.allowGravity = false;"),r.line("enemy.body.immovable = true;");break}r.dedent(),r.line("}")}}return r.toString()}function cr(t){let e=new T,r=t.some(s=>s.movement.kind==="patrol"),n=t.some(s=>s.movement.kind==="chase"),i=t.some(s=>s.movement.kind==="fly");return!r&&!n&&!i?"":(e.block("if (this.enemies)",s=>{s.block("this.enemies.getChildren().forEach((enemy) =>",a=>{a.line("const def = enemy.enemyDef;"),a.line("if (!def || !enemy.active) return;"),a.line(),r&&a.block("if (def.movement.kind === 'patrol')",o=>{o.line("const dist = Math.abs(enemy.x - enemy.patrolOriginX);"),o.block("if (dist >= enemy.patrolDistance)",l=>{l.line("enemy.setVelocityX(-enemy.body.velocity.x);"),l.line("enemy.setFlipX(enemy.body.velocity.x < 0);")})}),n&&a.block("if (def.movement.kind === 'chase')",o=>{o.line("const dist = Phaser.Math.Distance.Between(enemy.x, enemy.y, this.player.x, this.player.y);"),o.block("if (dist < enemy.chaseRange)",l=>{l.line("const angle = Phaser.Math.Angle.Between(enemy.x, enemy.y, this.player.x, this.player.y);"),l.line("enemy.setVelocityX(Math.cos(angle) * enemy.chaseSpeed);"),l.line("enemy.setFlipX(enemy.body.velocity.x < 0);")}),o.block("else",l=>{l.line("enemy.setVelocityX(0);")})}),i&&a.block("if (def.movement.kind === 'fly')",o=>{o.line("const time = this.time.now / 1000;"),o.line("enemy.y = enemy.flyOriginY + Math.sin(time * enemy.flyFrequency) * enemy.flyAmplitude;"),o.line("// Reverse direction at world bounds"),o.block("if (enemy.x <= 10 || enemy.x >= this.physics.world.bounds.width - 10)",l=>{l.line("enemy.setVelocityX(-enemy.body.velocity.x);")})})}),s.line(");")}),e.toString())}function pr(){let t=new T;return t.line("this.physics.add.overlap(this.player, this.enemies, (player, enemy) => {"),t.indent(),t.line("const def = enemy.enemyDef;"),t.line("if (!def) return;"),t.line(),t.line("// Stomp check: player falling and above enemy"),t.line("if (def.stompable && player.body.velocity.y > 0 && player.y < enemy.y - 10) {"),t.indent(),t.line("enemy.destroy();"),t.line("player.setVelocityY(-200); // bounce"),t.line("this.score += 50;"),t.dedent(),t.line("} else {"),t.indent(),t.line("this.handlePlayerDamage(def.damage);"),t.dedent(),t.line("}"),t.dedent(),t.line("});"),t.toString()}function ur(t,e){let r=new T;if(e.length===0)return"";r.line("this.collectibles = this.physics.add.group({ allowGravity: false });"),r.line();for(let n of e){let i=t.find(s=>s.name===n.entity);i&&(r.line("{"),r.indent(),r.line(`const item = this.collectibles.create(${n.x}, ${n.y}, '${i.sprite}');`),r.line(`item.collectDef = ${JSON.stringify({name:i.name,score:i.score,effect:i.effect})};`),i.animations.length>0&&r.line(`item.anims.play('${i.sprite}_${i.animations[0].name}');`),r.dedent(),r.line("}"))}return r.toString()}function mr(){let t=new T;return t.line("this.physics.add.overlap(this.player, this.collectibles, (player, item) => {"),t.indent(),t.line("const def = item.collectDef;"),t.line("if (!def) return;"),t.line(),t.line("item.destroy();"),t.line("this.score += def.score;"),t.line("if (this.collectSound) this.collectSound.play();"),t.line(),t.block("if (def.effect === 'extraLife')",e=>{e.line("this.lives = Math.min(this.lives + 1, this.maxLives);")}),t.block("else if (def.effect === 'speedBoost')",e=>{e.line("this.player.speedMultiplier = 1.5;"),e.line("this.time.delayedCall(5000, () => { this.player.speedMultiplier = 1; });")}),t.block("else if (def.effect === 'invincible')",e=>{e.line("this.player.invincible = true;"),e.line("this.player.setAlpha(0.5);"),e.line("this.time.delayedCall(5000, () => { this.player.invincible = false; this.player.setAlpha(1); });")}),t.line(),t.line("// Check collectAll win condition"),t.line('if (this.winCondition === "collectAll" && this.collectibles.countActive() === 0) {'),t.indent(),t.line("this.handleWin();"),t.dedent(),t.line("}"),t.dedent(),t.line("});"),t.toString()}function hr(t,e){let r=new T;if(!t.tilemap||!t.layers)return"";let i=e.find(s=>s.type==="image"&&s.key.includes("tile"))?.key??e.find(s=>s.type==="image")?.key??"tiles";r.line(`const map = this.make.tilemap({ key: '${t.tilemap}' });`),r.line(`const tileset = map.addTilesetImage('tileset', '${i}');`),r.line();for(let[s,a]of Object.entries(t.layers))r.line(`this.${s}Layer = map.createLayer('${a}', tileset, 0, 0);`),r.line(`if (this.${s}Layer) {`),r.indent(),r.line(`this.${s}Layer.setCollisionByExclusion([-1]);`),r.line(`this.physics.add.collider(this.player, this.${s}Layer);`),r&&r.line(`if (this.enemies) this.physics.add.collider(this.enemies, this.${s}Layer);`),r.dedent(),r.line("}");return r.toString()}function dr(t,e,r){let n=new T,i=Me(e.name),s=t.rules?.nextLevel?Me(t.rules.nextLevel):r<t.levels.length-1?Me(t.levels[r+1].name):null;return n.block(`class ${i} extends Phaser.Scene`,a=>{a.block("constructor()",o=>{o.line(`super({ key: '${i}' });`)}),a.line(),a.block("create()",o=>{if(o.line('this.score = this.registry.get("score") || 0;'),o.line(`this.lives = this.registry.get("lives") || ${t.player.lives};`),o.line(`this.maxLives = ${t.player.lives};`),o.line(`this.winCondition = "${t.rules?.win?.kind||"reachExit"}";`),o.line("this.isGameOver = false;"),o.line(),o.line(`this.cameras.main.setBackgroundColor('${t.config.background}');`),o.line(),o.raw(ar(t.player)),o.line(),o.raw(sr(t.player,e.spawn)),o.line(),e.tilemap&&e.layers&&o.raw(hr(e,t.assets)),e.platforms.length>0){o.line("this.platforms = this.physics.add.staticGroup();");for(let c of e.platforms)o.line(`this.platforms.create(${c.x+c.width/2}, ${c.y+c.height/2}, '${c.asset}').setDisplaySize(${c.width}, ${c.height}).refreshBody();`);o.line("this.physics.add.collider(this.player, this.platforms);"),o.line()}let l=lr(t.enemies,e.enemies);l&&(o.raw(l),o.line("this.physics.add.collider(this.enemies, this.platforms || []);"),o.line(),o.raw(pr()),o.line());let u=ur(t.collectibles,e.collectibles);u&&(o.raw(u),o.line(),o.raw(mr()),o.line()),e.exit&&(o.line(`this.exitZone = this.add.zone(${e.exit.x}, ${e.exit.y}, 40, 40);`),o.line("this.physics.add.existing(this.exitZone);"),o.line("this.exitZone.body.setAllowGravity(false);"),o.line("this.physics.add.overlap(this.player, this.exitZone, () => {"),o.indent(),o.line('if (this.winCondition === "reachExit") this.handleWin();'),o.dedent(),o.line("});"),o.line()),t.sounds?.jump&&o.line(`this.jumpSound = this.sound.add('${t.sounds.jump}');`),t.sounds?.collect&&o.line(`this.collectSound = this.sound.add('${t.sounds.collect}');`),t.sounds?.hurt&&o.line(`this.hurtSound = this.sound.add('${t.sounds.hurt}');`),t.sounds?.bgm&&(o.line(`this.bgm = this.sound.add('${t.sounds.bgm}', { loop: true });`),o.line("this.bgm.play();")),t.hud&&o.line("this.scene.launch('HudScene');"),t.rules?.lose?.kind==="fallOff"&&(o.line("this.physics.world.setBoundsCollision(true, true, true, false);"),o.line("this.player.setCollideWorldBounds(false);")),t.rules?.win?.kind==="survive"&&(o.line(`this.surviveTime = ${t.rules.win.seconds};`),o.line("this.elapsedTime = 0;"))}),a.line(),a.block("update(time, delta)",o=>{o.line("if (this.isGameOver) return;"),o.line(),o.raw(or(t.player)),o.line(),o.raw(cr(t.enemies)),o.line(),t.rules?.lose?.kind==="fallOff"&&o.block(`if (this.player.y > ${t.config.height+100})`,l=>{l.line("this.handlePlayerDamage(1);")}),t.rules?.win?.kind==="survive"&&(o.line("this.elapsedTime += delta / 1000;"),o.line("this.game.events.emit('updateTimer', this.surviveTime - this.elapsedTime);"),o.block("if (this.elapsedTime >= this.surviveTime)",l=>{l.line("this.handleWin();")})),o.line("this.game.events.emit('updateScore', this.score);"),o.line("this.game.events.emit('updateLives', this.lives);")}),a.line(),a.block("handlePlayerDamage(amount)",o=>{o.line("if (this.player.invincible) return;"),o.line("this.lives -= amount;"),o.line("if (this.hurtSound) this.hurtSound.play();"),o.line(),o.line("// Brief invincibility"),o.line("this.player.invincible = true;"),o.line("this.player.setAlpha(0.5);"),o.line("this.time.delayedCall(1000, () => {"),o.indent(),o.line("if (this.player) { this.player.invincible = false; this.player.setAlpha(1); }"),o.dedent(),o.line("});"),o.line(),o.block("if (this.lives <= 0)",l=>{l.line("this.handleGameOver();")})}),a.line(),a.block("handleWin()",o=>{o.line("if (this.isGameOver) return;"),o.line("this.isGameOver = true;"),o.line("if (this.bgm) this.bgm.stop();"),o.line('this.registry.set("score", this.score);'),o.line('this.registry.set("lives", this.lives);'),s?o.line(`this.scene.start('${s}');`):(o.line("this.add.text(this.cameras.main.centerX, this.cameras.main.centerY, 'YOU WIN!', { fontSize: '48px', color: '#00ff00' }).setOrigin(0.5);"),o.line("this.physics.pause();"))}),a.line(),a.block("handleGameOver()",o=>{o.line("if (this.isGameOver) return;"),o.line("this.isGameOver = true;"),o.line("if (this.bgm) this.bgm.stop();"),o.line("this.physics.pause();"),o.line("this.player.setTint(0xff0000);"),o.line("this.add.text(this.cameras.main.centerX, this.cameras.main.centerY, 'GAME OVER', { fontSize: '48px', color: '#ff0000' }).setOrigin(0.5);"),o.line("this.add.text(this.cameras.main.centerX, this.cameras.main.centerY + 60, 'Click to restart', { fontSize: '20px', color: '#ffffff' }).setOrigin(0.5);"),o.line("this.input.on('pointerdown', () => {"),o.indent(),o.line('this.registry.set("score", 0);'),o.line(`this.registry.set("lives", ${t.player.lives});`),o.line(`this.scene.start('${Me(t.levels[0].name)}');`),o.dedent(),o.line("});")})}),n.toString()}function Me(t){return"Level_"+t.replace(/[^a-zA-Z0-9]/g,"_")}function fr(t,e){let r=new T;return r.block("class HudScene extends Phaser.Scene",n=>{n.block("constructor()",i=>{i.line("super({ key: 'HudScene', active: false });")}),n.line(),n.block("create()",i=>{if(i.line("this.scoreText = null;"),i.line("this.livesText = null;"),i.line("this.timerText = null;"),i.line(),t)for(let s of t.elements)sn(i,s,e);i.line(),i.line("// Listen for HUD update events"),i.line("this.scene.get('BootScene'); // reference"),i.line("this.game.events.on('updateScore', (score) => {"),i.indent(),i.line("if (this.scoreText) this.scoreText.setText('Score: ' + score);"),i.dedent(),i.line("});"),i.line("this.game.events.on('updateLives', (lives) => {"),i.indent(),i.line("if (this.livesText) this.livesText.setText('Lives: ' + lives);"),i.dedent(),i.line("});"),i.line("this.game.events.on('updateTimer', (time) => {"),i.indent(),i.line("if (this.timerText) this.timerText.setText('Time: ' + Math.ceil(time));"),i.dedent(),i.line("});")})}),r.toString()}function sn(t,e,r){let{x:n,y:i}=on(e.position),s=e.fontSize??20,a=e.color??"#FFFFFF";switch(e.type){case"score":t.line(`this.scoreText = this.add.text(${n}, ${i}, 'Score: 0', { fontSize: '${s}px', color: '${a}' });`);break;case"lives":t.line(`this.livesText = this.add.text(${n}, ${i}, 'Lives: ${r}', { fontSize: '${s}px', color: '${a}' });`);break;case"timer":t.line(`this.timerText = this.add.text(${n}, ${i}, 'Time: 0', { fontSize: '${s}px', color: '${a}' });`);break}}function on(t){switch(t){case"top-left":return{x:16,y:16};case"top-right":return{x:700,y:16};case"top-center":return{x:350,y:16};case"bottom-left":return{x:16,y:560};case"bottom-right":return{x:700,y:560};case"bottom-center":return{x:350,y:560};default:return{x:16,y:16}}}var an="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js";function pt(t,e){let r=e?.phaserCdn??an,n=new T;n.line("<!DOCTYPE html>"),n.line('<html lang="en">'),n.line("<head>"),n.indent(),n.line('<meta charset="UTF-8">'),n.line('<meta name="viewport" content="width=device-width, initial-scale=1.0">'),n.line(`<title>${cn(t.title)}</title>`),n.line("<style>"),n.indent(),n.line("* { margin: 0; padding: 0; }"),n.line("body { background: #000; display: flex; justify-content: center; align-items: center; min-height: 100vh; }"),n.dedent(),n.line("</style>"),n.line(`<script src="${r}"><\/script>`),n.dedent(),n.line("</head>"),n.line("<body>"),n.line("<script>"),n.raw(ir(t)),n.line();for(let s=0;s<t.levels.length;s++)n.raw(dr(t,t.levels[s],s)),n.line();t.hud&&(n.raw(fr(t.hud,t.player.lives)),n.line());let i=["BootScene"];for(let s of t.levels)i.push(ln(s.name));return t.hud&&i.push("HudScene"),n.line("const config = {"),n.indent(),n.line("type: Phaser.AUTO,"),n.line(`width: ${t.config.width},`),n.line(`height: ${t.config.height},`),n.line("physics: {"),n.indent(),n.line("default: 'arcade',"),n.line("arcade: {"),n.indent(),n.line(`gravity: { y: ${t.config.gravity} },`),n.line("debug: false,"),n.dedent(),n.line("},"),n.dedent(),n.line("},"),n.line(`scene: [${i.join(", ")}],`),n.dedent(),n.line("};"),n.line(),n.line("const game = new Phaser.Game(config);"),n.line("<\/script>"),n.line("</body>"),n.line("</html>"),n.toString()}function ln(t){return"Level_"+t.replace(/[^a-zA-Z0-9]/g,"_")}function cn(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function gr(t,e){switch(e?.mode??"standalone-html"){case"standalone-html":return{html:pt(t,e),errors:[]};case"module":case"embed":return{html:pt(t,e),errors:[]}}}function yr(t,e){let r=ut(t);return mt(r,e)}function ut(t){let e=Zt(t),r=er(e),n=rr(r),i=tr(n);return i.valid||(n._warnings=i.errors),n}function mt(t,e){return gr(t,e)}return Nr(pn);})();
//# sourceMappingURL=phaser-platformer-dsl.js.map
